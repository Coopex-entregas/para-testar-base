<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Painel da Supervis√£o - Coopex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- MarkerCluster (AGRUPAMENTO) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    crossorigin=""
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    crossorigin=""
  />

  <style>
    :root{
      --royal:#0f35b5;
      --royal-2:#395de1;
      --royal-3:#6e8dff;

      --ink:#0a1b3f;
      --muted:#54679a;

      --bg:#eef3ff;
      --card:#ffffff;
      --line:#dbe6ff;
      --line-2:#c6d6ff;

      --good:#10b981;
      --bad:#ef4444;

      --warn:#f59e0b; /* mantido para uso futuro se quiser */
      --info:#2563eb;

      --r:16px;
      --shadow:0 10px 28px rgba(12, 38, 140, .10);
      --shadow-2:0 18px 44px rgba(12, 38, 140, .18);

      --toast-bg:rgba(2, 6, 23, .88);
      --toast-text:#fff;
    }

    body.dark{
      --bg:#0b1020;
      --card:#0f172a;
      --ink:#e7edf9;
      --muted:#a7b7e7;
      --line:#1d2a47;
      --line-2:#2a3a62;
      --shadow:0 12px 34px rgba(0,0,0,.28);
      --shadow-2:0 22px 54px rgba(0,0,0,.38);
      --toast-bg:rgba(255,255,255,.10);
      --toast-text:#fff;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 500px at 30% 0%, rgba(79,140,255,.18), transparent 55%),
        radial-gradient(900px 420px at 80% 20%, rgba(15,53,181,.14), transparent 60%),
        var(--bg);
      color:var(--ink);
    }

    a{color:inherit}
    a:focus,button:focus,select:focus,input:focus{ outline:2px solid rgba(47,77,230,.75);outline-offset:2px }

    /* ===== HEADER ===== */
    header{
      position:sticky; top:0; z-index:100;
      background:linear-gradient(90deg, var(--royal) 0%, var(--royal-2) 60%, var(--royal-3) 125%);
      color:#fff;
      box-shadow:var(--shadow-2);
      border-bottom:1px solid rgba(255,255,255,.18);
    }
    .topbar{
      width:100%;
      padding:14px 18px;
      display:grid;
      grid-template-columns:auto 1fr auto auto;
      gap:14px;
      align-items:center;
    }
    .brand{
      display:flex;align-items:center;gap:12px;font-weight:900;
      letter-spacing:.01em;
    }
    .brand span{
      font-size:1.05rem;
      text-shadow:0 2px 16px rgba(0,0,0,.22);
      white-space:nowrap;
    }

    .menu-btn{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.55);
      background:rgba(0,0,0,.14);
      display:inline-flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      cursor:pointer;
      padding:0;
      box-shadow:0 10px 22px rgba(0,0,0,.18) inset, 0 8px 20px rgba(0,0,0,.10);
      transition:transform .12s ease, filter .12s ease;
    }
    .menu-btn span{
      width:20px;height:2px;border-radius:99px;background:#fff;display:block;opacity:.95;
      transition:.18s;
    }
    .menu-btn:hover{filter:brightness(1.06)}
    .menu-btn:active{transform:scale(.98)}
    .menu-btn.open span:nth-child(1){transform:translateY(6px) rotate(45deg)}
    .menu-btn.open span:nth-child(2){opacity:0}
    .menu-btn.open span:nth-child(3){transform:translateY(-6px) rotate(-45deg)}

    .kpis{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .kpi{
      min-width:160px;
      padding:8px 12px;
      border:1px solid rgba(255,255,255,.35);
      border-radius:14px;
      background:rgba(255,255,255,.14);
      box-shadow:0 10px 18px rgba(0,0,0,.10) inset;
    }
    .kpi small{display:block;opacity:.95;font-weight:800}
    .kpi span{display:block;font-weight:900;font-size:1.18rem;line-height:1.1}

    .logout{
      color:#fff;
      background:linear-gradient(180deg,#d7263d 0%, #b91c1c 100%);
      border:1px solid rgba(255,255,255,.25);
      border-radius:14px;
      padding:10px 16px;
      font-weight:900;
      text-decoration:none;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .logout:hover{filter:brightness(1.05)}
    .theme-toggle{
      margin-left:6px;
      color:#fff;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.35);
      border-radius:14px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 10px 18px rgba(0,0,0,.12) inset;
    }
    .theme-toggle:hover{filter:brightness(1.06)}

    /* ===== BAR DA DATA ===== */
    .banner{
      display:flex;align-items:center;gap:14px;justify-content:space-between;
      background:linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.90));
      color:var(--ink);
      border-bottom:1px solid var(--line);
      padding:10px 18px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
    }
    body.dark .banner{
      background:linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.86));
      border-bottom:1px solid var(--line);
    }
    .today{font-weight:900}

    .badge{
      display:inline-flex;align-items:center;justify-content:center;
      border-radius:999px;padding:6px 10px;
      font-weight:900;font-size:.84rem;border:1px solid;
      user-select:none;
    }
    .badge.good{background:#eafff6;border-color:#bff3de;color:#0f8a64}
    .badge.bad{background:#ffefef;border-color:#ffd3d3;color:#b11e1e}
    .badge.neu{background:#edf3ff;border-color:#cfdbff;color:#2347c7}
    body.dark .badge.neu{background:#1b2750;border-color:#2b3b59;color:#cfe0ff}
    body.dark .badge.good{background:#0f2b22;border-color:#1c614d;color:#72f0c7}
    body.dark .badge.bad{background:#2e1313;border-color:#5b2828;color:#ffb4b4}

    /* ===== LAYOUT ===== */
    .viewport{padding:12px 14px 18px}
    .grid{position:relative; display:block}

    /* ===== Bot√µes ===== */
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      background:linear-gradient(90deg,var(--royal) 0%, var(--royal-2) 100%);
      color:#fff;border:1px solid rgba(255,255,255,.10);
      border-radius:14px;padding:10px 14px;font-weight:900;text-decoration:none;
      box-shadow:0 10px 22px rgba(8, 37, 140, .22);
      cursor:pointer;
      transition:filter .12s ease, transform .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:scale(.99)}
    .btn.alt{
      background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.90));
      color:#0a1b3f;
      border:1px solid var(--line);
      box-shadow:var(--shadow);
    }
    body.dark .btn.alt{
      background:linear-gradient(180deg, rgba(15,23,42,.96), rgba(15,23,42,.90));
      color:#e7edf9;
      border:1px solid var(--line);
    }
    .btn.disabled, .btn:disabled{opacity:.55; cursor:not-allowed; filter:saturate(.6); transform:none}

    /* ===== SIDEBAR ===== */
    .left{
      position:fixed;
      top:96px;
      right:16px;
      width:360px;
      max-width:92vw;
      max-height:calc(100vh - 110px);
      z-index:1500;
      display:none;
      flex-direction:column;
      gap:14px;
      min-height:0;
    }
    .left.open{display:flex;}
    .menu-panel{
      background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.90));
      border-radius:18px;
      box-shadow:0 22px 60px rgba(15,23,42,.42);
      border:1px solid var(--line);
      padding:12px 12px 14px;
      overflow:auto;
      max-height:100%;
      backdrop-filter: blur(8px);
    }
    body.dark .menu-panel{
      background:linear-gradient(180deg, rgba(15,23,42,.96), rgba(15,23,42,.90));
      border-color:var(--line);
    }
    .menu-header{
      display:flex; align-items:center; gap:10px; margin-bottom:10px;
    }
    .menu-header img{
      width:46px;height:46px;border-radius:14px;background:#fff;border:2px solid #eaf0ff;object-fit:contain;
    }
    .menu-header strong{font-size:.92rem;color:#18308f;font-weight:900}
    body.dark .menu-header strong{color:#cfe0ff}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
    }
    .card .body{padding:14px}
    .card h3{margin:0 0 10px;font-size:1rem;color:#213a99;font-weight:900}
    body.dark .card h3{color:#97b3ff}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .menu-section-title{
      font-size:.8rem;font-weight:900;text-transform:uppercase;letter-spacing:.04em;
      color:#4b61c7;margin:10px 2px 6px;
    }
    body.dark .menu-section-title{color:#9fb3ff}
    .menu-links{display:flex;flex-direction:column;gap:8px}
    .menu-links .btn{width:100%;justify-content:flex-start;padding:10px 12px;font-size:.88rem;border-radius:12px;box-shadow:none}

    /* ===== Lista de espera ===== */
    #espera-lista{list-style:none;margin:10px 0 0;padding:0;display:flex;flex-direction:column;gap:8px}
    .espera-chip{
      display:flex;align-items:center;gap:10px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:linear-gradient(180deg,#ffffff 0%, #f2f6ff 100%);
      cursor:grab;
    }
    body.dark .espera-chip{background:#0b1320;border-color:#1d2636}
    .espera-chip-num{
      width:26px;height:26px;border-radius:12px;
      display:inline-flex;align-items:center;justify-content:center;
      background:#eaf0ff;color:#1f3bb8;font-weight:900;border:1px solid #cfdbff;
      flex:0 0 auto;
    }
    body.dark .espera-chip-num{background:#1b2750;color:#cfe0ff;border-color:#2b3b59}
    .espera-chip-text{font-weight:900;color:#102a7a}
    body.dark .espera-chip-text{color:#cfe0ff}
    .espera-chip-remove{
      width:30px;height:30px;border-radius:12px;
      border:1px solid #ffd3d3;background:#ffefef;color:#b11e1e;
      font-weight:900;cursor:pointer;
    }
    body.dark .espera-chip-remove{background:#2e1313;border-color:#5b2828;color:#ffb4b4}

    /* ===== CONTE√öDO PRINCIPAL ===== */
    .panel{
      margin-top:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.90));
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow-2);
      overflow:hidden;
    }
    body.dark .panel{
      background:linear-gradient(180deg, rgba(15,23,42,.96), rgba(15,23,42,.90));
      border-color:var(--line);
    }

    .panel-head{
      background:linear-gradient(90deg, rgba(9, 33, 120, .95), rgba(15,53,181,.92));
      color:#fff;
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.16);
    }
    .panel-title{
      margin:0;
      font-size:1.02rem;
      font-weight:900;
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }

    /* ===== MAPA ===== */
    .map-wrapper{
      padding:12px 12px 6px;
      border-bottom:1px solid var(--line);
    }
    body.dark .map-wrapper{border-bottom:1px solid var(--line)}
    .map-header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px;
      font-size:.9rem;
      flex-wrap:wrap;
    }
    .map-header-main{display:flex;flex-direction:column;gap:6px}
    .map-header-main strong{font-weight:900}

    .map-legend-bar{
      margin-top:8px;
      display:flex;gap:12px;flex-wrap:wrap;
      background:linear-gradient(90deg, rgba(9, 33, 120, .95), rgba(15,53,181,.92));
      color:#fff;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 10px 26px rgba(0,0,0,.12);
    }
    .legend-dot{width:10px;height:10px;border-radius:999px;display:inline-block;border:1px solid rgba(255,255,255,.55)}
    .legend-dot.on{ background:#10b981; }
    .legend-dot.off{ background:#ef4444; }
    .legend-item{display:flex;align-items:center;gap:8px;font-weight:800;font-size:.84rem;opacity:.96}

    .map-header-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .map-search{
      min-width:240px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.45);
      padding:9px 10px;
      background:rgba(255,255,255,.14);
      color:#fff;
      font-size:.86rem;
      font-weight:800;
      outline:none;
    }

    .map-filter{
      min-width:180px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.08);
      color:#fff;
      outline:none;
    }
    .map-filter option{color:#0b1220;}

    .map-search option{ color:#000; }
    .map-full-btn{
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.45);
      color:#fff;
      border-radius:12px;
      padding:9px 12px;
      font-size:.86rem;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .map-full-btn:hover{filter:brightness(1.08)}

    #map-coopex{
      width:100%;
      height:340px;
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 10px 26px rgba(0,0,0,.18);
      background:#020617;
      border:1px solid rgba(255,255,255,.10);
    }
    @media (min-height:900px){ #map-coopex{height:390px;} }

    /* ===== FILTROS ===== */
    .filters-bar{
      padding:12px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.66);
      backdrop-filter: blur(8px);
    }
    body.dark .filters-bar{
      background:rgba(15,23,42,.72);
      border-bottom:1px solid var(--line);
    }

    .filters-top{
      display:flex;
      gap:12px;
      align-items:flex-end;
      flex-wrap:wrap;
    }

    .quick-left{
      flex:0 0 auto;
      min-width:220px;
    }
    .quick-left .btn{
      width:100%;
      justify-content:center;
      box-shadow:none;
      border:1px solid rgba(15,53,181,.25);
    }

    .filters-form{
      flex:1 1 760px;
      display:grid;
      grid-template-columns: 220px 160px 160px 200px 220px 1fr auto;
      gap:10px;
      align-items:end;
    }
    @media (max-width:1200px){
      .filters-form{
        grid-template-columns: 1fr 1fr 1fr;
      }
    }

    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:.82rem;color:#28409f;font-weight:900}
    body.dark label{color:#cfe0ff}

    select,input[type="date"],input[type="text"]{
      width:100%;
      padding:9px 10px;
      border-radius:12px;
      border:1.5px solid var(--line-2);
      background:#fff;
      color:var(--ink);
      font-weight:800;
    }
    body.dark select, body.dark input[type="date"], body.dark input[type="text"]{
      background:#0b1a3a; color:#e7edf9; border-color:#2b3b59;
    }
    .filters-form .btn{
      height:42px;
      box-shadow:none;
      border:1px solid rgba(15,53,181,.25);
    }

    .filters-actions{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
    }
    .filters-actions .btn{
      flex:1 1 220px;
      justify-content:center;
      box-shadow:none;
      border:1px solid rgba(15,53,181,.20);
    }

    /* ===== TABELA ===== */
    .table-shell{padding:12px;}
    .table-wrap{
      overflow:auto;
      border-radius:16px;
      border:1px solid var(--line);
      background:var(--card);
      box-shadow:var(--shadow);
    }
    body.dark .table-wrap{border-color:var(--line)}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:13.6px;
      color:var(--ink);
      background:transparent;
      min-width:1100px;
    }
    body.dark table{color:#e7edf9}
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background:linear-gradient(90deg, rgba(9, 33, 120, .98), rgba(15,53,181,.95));
      color:#fff;
      padding:10px 10px;
      font-weight:900;
      white-space:nowrap;
      border-bottom:1px solid rgba(255,255,255,.18);
    }
    thead th:first-child{border-top-left-radius:14px}
    thead th:last-child{border-top-right-radius:14px}
    tbody td{
      padding:10px 10px;
      text-align:center;
      vertical-align:middle;
      white-space:nowrap;
      border-bottom:1px solid rgba(219,230,255,.85);
    }
    body.dark tbody td{border-bottom:1px solid rgba(42,58,98,.85)}
    tbody tr:nth-child(even) td{background:rgba(238,243,255,.55)}
    body.dark tbody tr:nth-child(even) td{background:rgba(15,23,42,.55)}
    tbody tr:hover td{background:rgba(110,141,255,.12)}
    .small{font-size:.84rem;color:var(--muted)}
    body.dark .small{color:var(--muted)}

    /* Pills */
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:92px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      border:1px solid transparent;
      user-select:none;
    }
    .pill.red{background:#fee2e2; color:#991b1b; border-color:#fecaca;}
    .pill.green{background:#dcfce7; color:#166534; border-color:#bbf7d0;}
    .pill.yellow{background:#fef3c7; color:#92400e; border-color:#fde68a;}
    .pill.blue{background:#dbeafe; color:#1e40af; border-color:#bfdbfe;}
    body.dark .pill.red{background:#2e1313;color:#ffb4b4;border-color:#5b2828}
    body.dark .pill.green{background:#0f2b22;color:#72f0c7;border-color:#1c614d}
    body.dark .pill.yellow{background:#2a2110;color:#ffe4b0;border-color:#5a4520}
    body.dark .pill.blue{background:#1b2750;color:#cfe0ff;border-color:#2b3b59}

    /* ID com bolinha */
    .id-with-dot{display:inline-flex;align-items:center;gap:8px;justify-content:flex-start}
    .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;border:1px solid rgba(10,27,63,.25)}
    body.dark .status-dot{border-color:rgba(255,255,255,.25)}
    .status-dot.ok{background:#10b981}
    .status-dot.no{background:#ef4444}

    /* Edit√°veis */
    .coop-editable, .value-editable{
      cursor:pointer;
      font-weight:900;
      text-decoration:underline dotted rgba(10,27,63,.45);
      text-underline-offset:3px;
    }
    body.dark .coop-editable, body.dark .value-editable{
      text-decoration-color:rgba(255,255,255,.38);
    }

    .value-input{
      width:110px;
      max-width:140px;
      background:#fff;
      color:var(--ink);
      border:1.5px solid var(--line-2);
      border-radius:10px;
      padding:6px 8px;
      font-weight:900;
      text-align:center;
      outline:none;
    }
    body.dark .value-input{
      background:#0b1a3a;
      color:#e7edf9;
      border-color:#2b3b59;
    }

    /* A√ß√µes */
    .actions{display:flex; gap:8px; align-items:center; justify-content:center;}
    .act-open{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 12px; border-radius:12px; font-weight:900; text-decoration:none; color:#fff;
      background:linear-gradient(90deg, var(--royal) 0%, var(--royal-2) 100%);
      border:1px solid rgba(15,53,181,.25); box-shadow:none;
    }
    .act-open:hover{filter:brightness(1.06)}
    .act-ico{
      width:34px;height:34px; border-radius:12px;
      border:1px solid rgba(15,53,181,.18);
      background:rgba(15,53,181,.06);
      display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer; padding:0;
    }
    body.dark .act-ico{ border-color:rgba(255,255,255,.14); background:rgba(255,255,255,.08); }
    .act-ico:hover{filter:brightness(1.06)}
    .act-ico.danger{ background:#fee2e2; border-color:#fecaca; }
    body.dark .act-ico.danger{ background:#2e1313; border-color:#5b2828; }
    .act-ico svg{width:18px;height:18px}

    /* ===== Modal ===== */
    #overlay{
      position:fixed; inset:0; background:rgba(8,12,24,.78);
      display:none; align-items:center; justify-content:center; z-index:2000;
      backdrop-filter: blur(3px);
    }
    .modal{
      width:min(560px, 92vw);
      background:#fff; color:#0a1b3f;
      border-radius:16px; box-shadow:0 14px 44px rgba(0,0,0,.38);
      border:1px solid #e6ebff; overflow:hidden;
    }
    .modal header{
      padding:12px 16px; font-weight:900; color:var(--royal);
      border-bottom:1px solid #e6ebff; background:#f7f9ff
    }
    .modal .content{padding:14px 16px; font-weight:800}
    .modal footer{display:flex; gap:10px; justify-content:center; padding:12px; border-top:1px solid #e6ebff; background:#f8faff}
    .modal .ok{
      padding:10px 18px; border-radius:12px;
      border:1px solid var(--royal);
      background:linear-gradient(90deg,var(--royal) 0%, var(--royal-2) 100%);
      color:#fff; font-weight:900; cursor:pointer
    }
    body.dark .modal{background:#0f1623; color:#e7edf9; border-color:#1d2636}
    body.dark .modal header{color:#b9ccff; background:#0b1320; border-color:#1d2636}
    body.dark .modal footer{background:#0b1320; border-color:#1d2636}
    body.locked{overflow:hidden}

    /* ===== Toast ===== */
    #toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      z-index:2500;
      min-width:min(520px, 92vw);
      max-width:min(720px, 92vw);
      background:var(--toast-bg);
      color:var(--toast-text);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      border-radius:16px;
      padding:12px 14px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      backdrop-filter: blur(6px);
    }
    #toast strong{font-weight:900}
    #toast .x{
      border:none;
      background:rgba(255,255,255,.12);
      color:#fff;
      width:34px;height:34px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
    }
    #toast .x:hover{filter:brightness(1.08)}

    /* ===== √çCONE MOTO (marcador) ===== */
    .moto-pin{
      display:flex;
      align-items:center;
      justify-content:center;
      width:34px;
      height:34px;
      border-radius:14px;
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.75);
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      transform: translate3d(0,0,0);
    }
    .moto-pin svg{
      width:22px;
      height:22px;
      display:block;
    }
    .moto-pin.online svg{ fill: var(--good); }
    .moto-pin.offline svg{ fill: var(--bad); }

    .moto-highlight{
      outline: 3px solid rgba(110,141,255,.70);
      outline-offset: 2px;
      box-shadow: 0 0 0 8px rgba(110,141,255,.18), 0 18px 32px rgba(0,0,0,.22);
      animation: pulse 1.1s ease-in-out 2;
    }
    @keyframes pulse{
      0%{ transform: scale(1); }
      50%{ transform: scale(1.06); }
      100%{ transform: scale(1); }
    }

    /* ===== CLUSTER (verde se tem online, sen√£o vermelho) ===== */
    .cluster-badge{
      width:42px;height:42px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      color:#fff;
      font-weight:900;
      border:2px solid rgba(255,255,255,.75);
      box-shadow:0 10px 22px rgba(0,0,0,.20);
      background:#64748b;
    }
    .cluster-badge.online{ background: #10b981; }
    .cluster-badge.offline{ background: #ef4444; }
  
    /* ===== FOTO COMPROVANTE ===== */
    .foto-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:30px;height:30px;border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      text-decoration:none;
      font-weight:900;
      line-height:1;
    }
    .foto-btn.foto-ok{ background:rgba(16,185,129,.18); border-color:rgba(16,185,129,.55); }
    .foto-btn.foto-no{ background:rgba(239,68,68,.16); border-color:rgba(239,68,68,.55); opacity:.95; }
    .foto-dl{
      margin-left:6px;
      display:inline-flex; align-items:center; justify-content:center;
      width:28px;height:28px;border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      text-decoration:none;
      font-weight:900;
    }

  
    .recb-wrap{display:flex;flex-direction:column;align-items:center;gap:6px}
    .recb-nome{font-weight:800;font-size:.86rem;opacity:.92;max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}


    .socorro-bar{
      position:fixed; left:16px; right:16px; bottom:16px;
      background:linear-gradient(90deg,#b91c1c,#ef4444);
      color:#fff; border-radius:16px; padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      box-shadow:0 18px 40px rgba(0,0,0,.30);
      z-index:9999;
    }
    .socorro-left{display:flex; flex-direction:column; gap:4px}
    .socorro-title{font-weight:900; letter-spacing:.2px}
    .socorro-count{background:rgba(255,255,255,.2); padding:2px 8px; border-radius:999px; margin-left:6px}
    .socorro-msg{font-weight:700; opacity:.95; font-size:.92rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:70vw}
    .socorro-x{border:none; background:rgba(255,255,255,.2); color:#fff; font-size:22px; width:38px; height:38px; border-radius:12px; cursor:pointer; font-weight:900}
    .socorro-x:hover{background:rgba(255,255,255,.28)}


/* MAPA: modo tela cheia (fallback se Fullscreen API falhar) */
.map-card.fullscreen {
  position: fixed;
  top: 12px; left: 12px; right: 12px; bottom: 12px;
  z-index: 99999;
  border-radius: 16px;
  overflow: hidden;
}
.map-card.fullscreen #map-coopex {
  height: calc(100vh - 120px) !important;
}

</style>
</head>

<body>
  <!-- HEADER -->
  <header>
    <div class="topbar">
      <div class="brand">
        <button id="btnMenu" class="menu-btn" type="button" aria-label="Abrir menu principal">
          <span></span><span></span><span></span>
        </button>
        <span>Kratos System ‚Äì Supervis√£o</span>
      </div>

      <div class="kpis">
        <div class="kpi"><small>Entregas do Dia</small><span>{{ estatisticas.total_dia }}</span></div>
        <div class="kpi"><small>Do M√™s</small><span>{{ estatisticas.total_mes }}</span></div>
        <div class="kpi"><small>Do Ano</small><span>{{ estatisticas.total_ano }}</span></div>
      </div>

      <button id="btnTheme" class="theme-toggle" type="button">Modo escuro</button>
      <a class="logout" href="{{ url_for('logout') }}">Sair</a>
    </div>
  </header>

  <!-- BANNER -->
  <div class="banner">
    <div class="today">{{ to_brasilia(now()).strftime('%d/%m/%Y') }} ‚Äî {{ to_brasilia(now())|diasemana }}</div>
    <div>
      {% if feriado_hoje %}
        <span class="badge bad">‚ö† {{ feriado_hoje }}</span>
      {% else %}
        <span class="badge neu">Hoje n√£o √© feriado</span>
      {% endif %}
    </div>
  </div>

  <div class="viewport">
    <div class="grid">

      <!-- MENU LATERAL -->
      <aside class="left" id="sidePanel">
        <div class="menu-panel">
          <div class="menu-header">
            <img src="{{ url_for('static', filename='logo_kratos.png') }}"
                 alt="Logo"
                 onerror="this.onerror=null;this.src='https://via.placeholder.com/90x38?text=LOGO'">
            <strong>Menu r√°pido & Lista de Espera</strong>
          </div>

          <!-- LISTA DE ESPERA -->
          <div class="card" style="margin-bottom:10px;">
            <div class="body">
              <h3>Lista de Espera</h3>
              <form class="row" action="{{ url_for('lista_espera_add') }}" method="POST" id="form-espera">
                {% set coops_select = cooperados_disponiveis if (cooperados_disponiveis is defined and cooperados_disponiveis|length > 0) else cooperados %}
                <select name="cooperado_id" id="cooperado-espera" required>
                  <option value="" selected disabled>Selecione um cooperado‚Ä¶</option>
                  {% for c in coops_select %}<option value="{{ c.id }}">{{ c.nome }}</option>{% endfor %}
                </select>
                <input name="nome" id="nome-espera" type="text" placeholder="(Opcional) nome do cooperado" />
                <button type="submit" class="btn">Adicionar</button>
              </form>

              <ul id="espera-lista">
                {% if lista_espera|length == 0 %}
                  <li id="fila-vazia" class="small" style="opacity:.85">Nenhum cooperado na fila.</li>
                {% else %}
                  {% for item in lista_espera %}
                    <li class="espera-chip" draggable="true" data-id="{{ item.id }}">
                      <span class="espera-chip-num">{{ loop.index }}</span>
                      <span class="espera-chip-text">{{ item.nome }}</span>
                      <form action="{{ url_for('lista_espera_remove', id=item.id) }}" method="POST" style="margin-left:auto">
                        <button class="espera-chip-remove" title="Remover" type="submit">√ó</button>
                      </form>
                    </li>
                  {% endfor %}
                {% endif %}
              </ul>
            </div>
          </div>

          <!-- A√á√ïES -->
          <div>
            <div class="menu-section-title">Outras a√ß√µes</div>
            <div class="menu-links">
              <a class="btn alt" href="{{ url_for('clientes') }}">Clientes</a>
              <a class="btn alt" href="{{ url_for('cadastrar_cooperado') }}">Cooperados</a>
              {% if session.is_master %}
                <a class="btn alt" href="{{ url_for('estatisticas_cooperado') }}">Dashboard</a>
              {% endif %}
              <a class="btn alt" href="{{ url_for('creditos') }}">Cr√©dito</a>
              <a class="btn alt" href="{{ url_for('precos_rotas') }}">Tabela de Pre√ßos &amp; Rotas</a>

              <a class="btn alt" href="{{ url_for('exportar_xlsx',
                   data_inicio=data_inicio or '',
                   data_fim=data_fim or '',
                   cooperado_id=request.args.get('cooperado_id','todos'),
                   status_pagamento=request.args.get('status_pagamento','todos'),
                   cliente=request.args.get('cliente',''),
                   endereco=request.args.get('endereco','')) }}">Exportar</a>

              <a class="btn alt" target="_blank" rel="noopener" href="{{ url_for('relatorio_termico',
                   data_inicio=data_inicio or '',
                   data_fim=data_fim or '',
                   cooperado_id=request.args.get('cooperado_id','todos'),
                   status_pagamento=request.args.get('status_pagamento','todos'),
                   cliente=request.args.get('cliente',''),
                   endereco=request.args.get('endereco','')) }}">Imprimir Relat√≥rio</a>

              <a class="btn alt" href="{{ url_for('trajetos') }}">Trajetos (hist√≥rico)</a>
            </div>
          </div>
        </div>
      </aside>

      <!-- CONTE√öDO PRINCIPAL -->
      <section class="panel">
        <div class="panel-head">
          <h2 class="panel-title">
            Entregas de {{ to_brasilia(now()).strftime('%d/%m/%Y') }}
            <span id="abertasBadge" class="badge neu" title="Entregas sem cooperado" style="display:none">0 em aberto</span>
          </h2>
          <div class="small" style="color:rgba(255,255,255,.92);font-weight:900">Ajuda n√£o √© fardado</div>
        </div>

        <!-- MAPA -->
        <div class="map-wrapper" style="background:linear-gradient(90deg, rgba(9, 33, 120, .95), rgba(15,53,181,.92));">
          <div class="map-header">
            <div class="map-header-main">
              <strong style="color:#fff">Mapa em tempo real</strong>

              <div class="map-legend-bar">
                <div class="legend-item"><span class="legend-dot on"></span> Online (app ligado)</div>
                <div class="legend-item"><span class="legend-dot off"></span> Offline / desconectado</div>
              </div>
            </div>

            <div class="map-header-actions">
              <select id="mapSearch" class="map-search">
                <option value="">üîç Localizar motoboy‚Ä¶</option>
              </select>

              <select id="mapFilter" class="map-filter">
                <option value="all">üëÅÔ∏è Ver todos</option>
                <option value="online">üü¢ S√≥ online</option>
              </select>

              <button id="btnFullMap" class="map-full-btn" type="button">Mapa em tela cheia</button>
            </div>
          </div>

          <div id="map-coopex"></div>
        </div>

        <!-- FILTROS -->
        <div class="filters-bar">
          <div class="filters-top">
            <div class="quick-left">
              <button class="btn" type="button" onclick="window.location.href='{{ url_for('cadastrar_entrega') }}'">
                + Nova entrega
              </button>
            </div>

            <form class="filters-form" method="GET" action="{{ url_for('admin') }}">
              <div class="field">
                <label for="cooperado">Cooperado</label>
                <select name="cooperado_id" id="cooperado">
                  <option value="todos">Todos</option>
                  {% for c in cooperados %}
                    <option value="{{ c.id }}" {% if request.args.get('cooperado_id') == c.id|string %}selected{% endif %}>{{ c.nome }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="field">
                <label for="data_inicio">De</label>
                <input type="date" name="data_inicio" id="data_inicio" value="{{ data_inicio or '' }}" />
              </div>

              <div class="field">
                <label for="data_fim">At√©</label>
                <input type="date" name="data_fim" id="data_fim" value="{{ data_fim or '' }}" />
              </div>

              <div class="field">
                <label for="status_pagamento">Pagamento</label>
                <select name="status_pagamento" id="status_pagamento">
                  <option value="todos" {% if request.args.get('status_pagamento','todos')=='todos' %}selected{% endif %}>Todos</option>
                  <option value="pago" {% if request.args.get('status_pagamento')=='pago' %}selected{% endif %}>Pago</option>
                  <option value="pendente" {% if request.args.get('status_pagamento')=='pendente' %}selected{% endif %}>Pendente</option>
                </select>
              </div>

              <div class="field">
                <label for="cliente">Cliente</label>
                <input type="text" name="cliente" id="cliente" placeholder="Nome do cliente" value="{{ request.args.get('cliente','') }}" />
              </div>

              <div class="field">
                <label for="endereco">Endere√ßo</label>
                <input type="text" name="endereco" id="endereco" placeholder="Rua, n¬∫, ponto de ref." value="{{ request.args.get('endereco','') }}" />
              </div>

              <button class="btn" type="submit">Filtrar</button>
            </form>
          </div>

          <div class="filters-actions">
            <button class="btn alt" type="button" onclick="window.location.href='{{ url_for('agendar_entrega') }}'">
              + Agendar entrega
            </button>
            <button class="btn alt" type="button" onclick="window.location.href='{{ agenda_url }}'">
              Ver agenda
            </button>
          </div>
        </div>

        <!-- TABELA -->
        <div class="table-shell">
          <div class="table-wrap" id="tbl">
            <table class="tabela">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Cliente</th>
                  <th>Bairro</th>
                  <th>Endere√ßo</th>
                  <th>Valor</th>
                  <th>Data<br>e<br>Dia</th>
                  <th>Hora<br>Pedido</th>
                  <th>Hora<br>Atribu√≠da</th>
                  <th>Cooperado</th>
                  <th>Forma Pgto</th>
                  <th>Status</th>
                  <th>Pagamento</th>
                  <th>Recebido por</th>
                  <th>Rastreio</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>

              <tbody>
                {% for e in entregas %}
                {% set tem_coop = (e.cooperado is not none) %}
                {% set sp = e.status_pagamento|lower if e.status_pagamento else 'pendente' %}
                {% set st = e.status|lower if e.status else 'pendente' %}
                <tr data-id="{{ e.id }}">
                  <td>
                    <span class="id-with-dot">
                      <span class="status-dot {{ 'ok' if tem_coop else 'no' }}"
                            title="{{ 'Com cooperado atribu√≠do' if tem_coop else 'Sem cooperado' }}"></span>
                      <span>{{ e.id }}</span>
                    </span>
                  </td>

                  <td>{{ e.cliente }}</td>
                  <td>{{ e.bairro }}</td>
                  <td>{{ e.endereco if e.endereco is defined and e.endereco else '-' }}</td>

                  <td>
                    <span class="value-editable"
                          data-id="{{ e.id }}"
                          data-valor="{{ '%.2f'|format(e.valor) }}"
                          title="Clique para alterar o valor">
                      R$ {{ '%.2f'|format(e.valor) | replace('.', ',') }}
                    </span>
                  </td>

                  <td>
                    {{ to_brasilia(e.data_envio).strftime('%d/%m/%Y') if e.data_envio else '-' }}<br>
                    <span class="small">{{ to_brasilia(e.data_envio)|diasemana if e.data_envio else '' }}</span>
                  </td>

                  <td>{{ to_brasilia(e.data_envio).strftime('%H:%M') if e.data_envio else '-' }}</td>
                  <td>{{ to_brasilia(e.data_atribuida).strftime('%H:%M') if e.data_atribuida else '-' }}</td>

                  <td>
                    <span class="coop-editable"
                          data-id="{{ e.id }}"
                          data-cooperado-id="{{ e.cooperado.id if e.cooperado else '' }}"
                          title="Clique para trocar o cooperado">
                      {{ e.cooperado.nome if e.cooperado else 'Sem Cooperado' }}
                    </span>
                  </td>

                  <td>{{ e.pagamento }}</td>

                  <td>
                    {% set st_val = (e.status or 'pendente')|lower %}
                    <span class="status-editable"
                          data-id="{{ e.id }}"
                          data-status="{{ st_val }}"
                          title="Clique para alterar o status da entrega">
                      {% if st_val in ['entregue','recebido'] %}
                        <span class="pill yellow">Entregue</span>
                      {% elif st_val in ['agendado'] %}
                        <span class="pill blue">Agendado</span>
                      {% else %}
                        <span class="pill red">Pendente</span>
                      {% endif %}
                    </span>
                  </td>

                  <td>
                    {% set sp_val = (e.status_pagamento or 'pendente')|lower %}
                    <span class="pagamento-editable"
                          data-id="{{ e.id }}"
                          data-status-pagamento="{{ sp_val }}"
                          title="Clique para alterar o status do pagamento">
                      {% if sp_val == 'pago' %}
                        <span class="pill green">Pago</span>
                      {% else %}
                        <span class="pill red">Pendente</span>
                      {% endif %}
                    </span>
                  </td>

                  <td class="td-recebido" style="text-align:center">
                    <div class="recb-wrap">
                      {% if tem_comprovante(e.id) %}
                        <a class="foto-btn foto-ok" title="Ver foto" target="_blank" rel="noopener" href="{{ url_for('admin_ver_comprovante', entrega_id=e.id) }}">üì∑</a>
                        <a class="foto-dl" title="Baixar foto" href="{{ url_for('admin_baixar_comprovante', entrega_id=e.id) }}">‚¨á</a>
                      {% else %}
                        <span class="foto-btn foto-no" title="Sem foto">üì∑</span>
                      {% endif %}
                      <div class="recb-nome" title="{{ e.recebido_por or '-' }}">{{ e.recebido_por or '-' }}</div>
                    </div>
                  </td>

                  <td>
                    {% set st_ent = (e.status or '')|lower %}
                    {% if tem_coop and st_ent not in ['recebido','entregue'] %}
                      {% set rastreio_link = url_for('rastreio_publico', token=token_rastreio(e.id), _external=True) %}
                      <a href="{{ rastreio_link }}" target="_blank" class="act-open" rel="noopener">Abrir</a>
                    {% elif tem_coop %}
                      <span class="small">Encerrado</span>
                    {% else %}
                      <span class="small">‚Äî</span>
                    {% endif %}
                  </td>

                  <td>
                    <div class="actions">
                      <a class="act-ico" title="Editar" href="{{ url_for('editar_entrega', id=e.id) }}" aria-label="Editar">
                        <svg viewBox="0 0 24 24" fill="#1e40af">
                          <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM21.41 6.34c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                        </svg>
                      </a>

                      <form action="{{ url_for('clonar_entrega', id=e.id) }}" method="POST" style="display:inline;">
                        <button class="act-ico" title="Clonar" type="submit" aria-label="Clonar">
                          <svg viewBox="0 0 24 24" fill="#1e40af">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v12h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                          </svg>
                        </button>
                      </form>

                      <button type="button" class="act-ico" title="Imprimir cupom"
                        data-id="{{ e.id }}"
                        data-cliente="{{ e.cliente|e }}"
                        data-bairro="{{ e.bairro|e }}"
                        data-endereco="{{ (e.endereco if e.endereco is defined and e.endereco else '-')|e }}"
                        data-valor="{{ '%.2f'|format(e.valor) }}"
                        data-data="{{ to_brasilia(e.data_envio).strftime('%d/%m/%Y') if e.data_envio else '-' }}"
                        data-hora_pedido="{{ to_brasilia(e.data_envio).strftime('%H:%M') if e.data_envio else '-' }}"
                        data-hora_atribuida="{{ to_brasilia(e.data_atribuida).strftime('%H:%M') if e.data_atribuida else '-' }}"
                        data-cooperado="{{ e.cooperado.nome if e.cooperado else 'Sem Cooperado' }}"
                        data-pagamento="{{ e.pagamento|e }}"
                        
                        data-recebido="{{ (e.recebido_por if e.recebido_por is defined else \'\')|e }}"onclick="imprimirCupom({{ e.id }}, this)">
                        <svg viewBox="0 0 24 24" fill="#16a34a">
                          <path d="M19 8h-1V3c0-1.104-.896-2-2-2H8C6.896 1 6 1.896 6 3v5H5C2.794 8 1 9.794 1 12v6c0 2.206 1.794 4 4 4h2v-3h10v3h2c2.206 0 4-1.794 4-4v-6c0-2.206-1.794-4-4-4zM8 3h8v5H8V3zm8 14H8v-4h8v4z"/>
                        </svg>
                      </button>

                      <form action="{{ url_for('excluir_entrega', id=e.id) }}" method="POST"
                            style="display:inline;"
                            onsubmit="return confirm('Tem certeza que deseja excluir esta entrega?');">
                        <button class="act-ico danger" title="Excluir" type="submit" aria-label="Excluir">
                          <svg viewBox="0 0 24 24" fill="#b91c1c">
                            <path d="M3 6h18v2H3V6zm2 3h14l-1.5 13H6.5L5 9zm2.5 2v9h2v-9h-2zm4 0v9h2v-9h-2z"/>
                          </svg>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

      </section>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite">
    <div id="toastText"><strong>Ok</strong></div>
    <button class="x" type="button" onclick="hideToast()">√ó</button>
  </div>

  <!-- Modal (mantido para outras mensagens do sistema; n√£o abre no cluster) -->
  <div id="overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal">
      <header id="modal-title">Aviso</header>
      <div class="content" id="modal-msg">Mensagem</div>
      <footer>
        <button id="modal-ok" class="ok" type="button">Ok</button>
      </footer>
    </div>
  </div>

  <!-- √°udios -->
  <audio id="som-pendente" src="{{ url_for('static', filename='aviso_pendente.mp3') }}"></audio>
  <audio id="som-socorro" src="{{ url_for('static', filename='socorro.mp3') }}"></audio>

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    const socket = io("{{ request.host_url.rstrip('/') }}", {
      transports: ["polling"],
      path: "/socket.io/",
      reconnection: true,
      reconnectionAttempts: Infinity,
      reconnectionDelay: 1000
    });
    socket.on("connect", () => console.log("Socket conectado (polling), id:", socket.id));
    socket.on("connect_error", (err) => console.error("Erro na conex√£o Socket.IO:", err));
  </script>

  <script>
    window.COOPERADOS = {{ cooperados_js | default([]) | tojson | safe }};
    window.MOTOBOYS   = {{ motoboys_js | default([]) | tojson | safe }};

    function formatBRLFromNumberLike(v){
      const n = Number(String(v).replace(",", "."));
      if (Number.isFinite(n)) return "R$ " + n.toFixed(2).replace(".", ",");
      return String(v || "").trim() || "R$ 0,00";
    }
    function parseNumberFromBRL(text){
      if(!text) return 0;
      let t = String(text).replace(/[^\d,.-]/g,'').trim();
      t = t.replace(/\.(?=\d{3}(\D|$))/g, '');
      t = t.replace(',', '.');
      const n = Number(t);
      return Number.isFinite(n) ? n : 0;
    }

    let _toastTimer = null;
    function showToast(msg){
      const el = document.getElementById('toast');
      const tx = document.getElementById('toastText');
      if(!el || !tx) return;
      tx.innerHTML = msg;
      el.style.display = 'flex';
      clearTimeout(_toastTimer);
      _toastTimer = setTimeout(hideToast, 2600);
    }
    function hideToast(){
      const el = document.getElementById('toast');
      if(!el) return;
      el.style.display = 'none';
      clearTimeout(_toastTimer);
      _toastTimer = null;
    }

    function showModal(title, html){
      const ov = document.getElementById('overlay');
      const tt = document.getElementById('modal-title');
      const msg = document.getElementById('modal-msg');
      if(!ov || !tt || !msg) return;
      tt.textContent = title || 'Aviso';
      msg.innerHTML = html || '';
      ov.style.display = 'flex';
      document.body.classList.add('locked');
    }
    function hideModal(){
      const ov = document.getElementById('overlay');
      if(!ov) return;
      ov.style.display = 'none';
      document.body.classList.remove('locked');
    }
    window.addEventListener('DOMContentLoaded', ()=>{
      const ok = document.getElementById('modal-ok');
      const ov = document.getElementById('overlay');
      if(ok) ok.addEventListener('click', hideModal);
      if(ov) ov.addEventListener('click', (e)=>{
        if(e.target === ov) hideModal();
      });
    });

    function contarSemCooperado(){
      try{
        const rows = document.querySelectorAll('.tabela tbody tr');
        let n = 0;
        rows.forEach(tr=>{
          const el = tr.querySelector('.coop-editable');
          const cid = el?.dataset?.cooperadoId || '';
          if(!cid) n++;
        });
        return n;
      }catch(e){ return 0; }
    }
    function atualizarBadgeAbertas(){
      const badge = document.getElementById('abertasBadge');
      if(!badge) return;
      const n = contarSemCooperado();
      badge.textContent = n + ' em aberto';
      badge.style.display = 'inline-flex';
    }

    (function(){
      try{
        const saved = localStorage.getItem('coopex_theme') || 'light';
        if(saved === 'dark') document.body.classList.add('dark');
        const btn = document.getElementById('btnTheme');
        const sync = ()=> btn && (btn.textContent = document.body.classList.contains('dark') ? 'Modo claro' : 'Modo escuro');
        if(btn){
          sync();
          btn.addEventListener('click', ()=>{
            document.body.classList.toggle('dark');
            localStorage.setItem('coopex_theme', document.body.classList.contains('dark') ? 'dark' : 'light');
            sync();
          });
        }
      }catch(e){}
    })();

    window.addEventListener('DOMContentLoaded', atualizarBadgeAbertas);

    document.addEventListener('click', (ev)=>{
      const st = ev.target.closest?.('.js-toggle-pagto, .js-toggle-entrega');
      if(!st) return;
      const form = st.closest?.('form');
      if(!form) return;

      const confirmar = st.classList.contains('js-toggle-pagto')
        ? 'Confirmar pagamento como PAGO?'
        : 'Confirmar entrega como ENTREGUE?';
      if(!confirm(confirmar)) return;

      ev.preventDefault();
      try{
        const fd = new FormData(form);
        fetch(form.action, { method:'POST', body:fd, headers:{'X-Requested-With':'fetch'} })
          .then(res=>{
            if(!res.ok) throw new Error('Falha ao atualizar.');
            showToast('<strong>Atualizado com sucesso.</strong>');
            setTimeout(()=> location.reload(), 350);
          })
          .catch(()=> showToast('<strong>N√£o foi poss√≠vel atualizar agora.</strong>'));
      }catch(e){
        showToast('<strong>N√£o foi poss√≠vel atualizar agora.</strong>');
      }
    });

    function removerDaFilaPorNome(nome){
      try{
        if(!nome) return;
        const ul = document.getElementById('espera-lista');
        if(!ul) return;

        const itens = ul.querySelectorAll('.espera-chip');
        let alvo = null;
        itens.forEach(li=>{
          const txt = (li.querySelector('.espera-chip-text')?.textContent || '').trim().toLowerCase();
          if(txt && txt === String(nome).trim().toLowerCase()) alvo = li;
        });
        if(!alvo) return;

        const form = alvo.querySelector('form');
        if(form?.action){
          fetch(form.action, { method:'POST', headers:{'X-Requested-With':'fetch'} }).catch(()=>{});
        }
        alvo.remove();

        const restou = ul.querySelectorAll('.espera-chip').length;
        if(restou === 0){
          const li = document.createElement('li');
          li.id = 'fila-vazia';
          li.className = 'small';
          li.style.opacity = '.85';
          li.textContent = 'Nenhum cooperado na fila.';
          ul.appendChild(li);
        }
      }catch(e){}
    }

    document.addEventListener('click', (ev)=>{
      const el = ev.target.closest?.('.coop-editable');
      if(!el) return;

      const idEntrega = el.dataset?.id || '';
      const atual     = el.dataset?.cooperadoId || '';

      const sel = document.createElement('select');
      sel.style.borderRadius='12px';
      sel.style.padding='7px 10px';
      sel.style.fontWeight='900';

      const opt0 = document.createElement('option');
      opt0.value=''; opt0.textContent='Sem Cooperado';
      sel.appendChild(opt0);

      (window.COOPERADOS || []).forEach(c=>{
        const o = document.createElement('option');
        o.value=c.id;
        o.textContent=c.nome;
        if(String(c.id)===String(atual)) o.selected=true;
        sel.appendChild(o);
      });

      el.parentNode.replaceChild(sel, el);
      sel.focus();

      function salvar(){
        const coopId = sel.value || '';
        let nomeEscolhido = 'Sem Cooperado';
        if(sel.selectedIndex >= 0) nomeEscolhido = (sel.options[sel.selectedIndex]?.textContent || 'Sem Cooperado').trim();

        try{
          const url = '/atribuir_cooperado/' + idEntrega;
          const fd  = new FormData();
          fd.append('cooperado_id', coopId);
          fd.append('notificar_painel', '1');

          fetch(url,{ method:'POST', body:fd, headers:{'X-Requested-With':'fetch'} })
            .then(()=>{
              if(coopId) removerDaFilaPorNome(nomeEscolhido);
              showToast('<strong>Cooperado atualizado.</strong>');
            })
            .catch(()=> showToast('<strong>N√£o foi poss√≠vel atualizar o cooperado agora.</strong>'));
        }catch(e){
          showToast('<strong>N√£o foi poss√≠vel atualizar o cooperado agora.</strong>');
        }

        const span = document.createElement('span');
        span.className = 'coop-editable';
        span.dataset.id = idEntrega;
        span.dataset.cooperadoId = sel.value;
        span.title = 'Clique para trocar o cooperado';

        let nome = 'Sem Cooperado';
        if(sel.value){
          const found = (window.COOPERADOS || []).find(x => String(x.id)===String(sel.value));
          if(found?.nome) nome = found.nome;
        }
        span.textContent = nome;
        sel.parentNode.replaceChild(span, sel);

        atualizarBadgeAbertas();
      }

      sel.addEventListener('change', salvar);
      sel.addEventListener('blur', ()=> salvar(), { once:true });
    });

    async function salvarInlineEntrega(idEntrega, payload){
      try{
        const r = await fetch(`/api/entregas/${idEntrega}/inline`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json','X-Requested-With':'fetch'},
          body: JSON.stringify(payload || {})
        });
        if(!r.ok) return null;
        return await r.json();
      }catch(e){
        return null;
      }
    }

    function makePillStatus(st){
      st = (st||'').toLowerCase();
      if(st === 'agendado') return '<span class="pill blue">Agendado</span>';
      if(st === 'entregue' || st === 'recebido') return '<span class="pill yellow">Entregue</span>';
      return '<span class="pill red">Pendente</span>';
    }
    function makePillPagto(sp){
      sp = (sp||'').toLowerCase();
      if(sp === 'pago') return '<span class="pill green">Pago</span>';
      return '<span class="pill red">Pendente</span>';
    }

    document.addEventListener('click', (ev)=>{
      const el = ev.target.closest?.('.status-editable');
      if(!el) return;
      ev.preventDefault(); ev.stopPropagation();

      const idEntrega = el.dataset?.id || '';
      const atual = (el.dataset?.status || '').toLowerCase();

      const sel = document.createElement('select');
      sel.style.borderRadius='12px';
      sel.style.padding='7px 10px';
      sel.style.fontWeight='900';

      const opts = [
        {v:'pendente', t:'Pendente'},
        {v:'agendado', t:'Agendado'},
        {v:'recebido', t:'Entregue'},
      ];
      opts.forEach(o=>{
        const op=document.createElement('option');
        op.value=o.v; op.textContent=o.t;
        if(o.v===atual || (atual==='' && o.v==='pendente')) op.selected=true;
        sel.appendChild(op);
      });

      el.parentNode.replaceChild(sel, el);
      sel.focus();

      async function salvar(){
        const st = sel.value || 'pendente';
        const res = await salvarInlineEntrega(idEntrega, {status: st});
        const span = document.createElement('span');
        span.className='status-editable';
        span.dataset.id=idEntrega;
        span.dataset.status=st;
        span.title='Clique para alterar o status da entrega';
        span.innerHTML = makePillStatus(st);
        sel.parentNode.replaceChild(span, sel);

        if(res && res.ok){
          showToast('<strong>Status atualizado.</strong>');
        }else{
          showToast('<strong>N√£o foi poss√≠vel atualizar o status agora.</strong>');
        }
      }

      sel.addEventListener('change', salvar);
      sel.addEventListener('blur', ()=> salvar(), {once:true});
    });

    document.addEventListener('click', (ev)=>{
      const el = ev.target.closest?.('.pagamento-editable');
      if(!el) return;
      ev.preventDefault(); ev.stopPropagation();

      const idEntrega = el.dataset?.id || '';
      const atual = (el.dataset?.statusPagamento || '').toLowerCase();

      const sel = document.createElement('select');
      sel.style.borderRadius='12px';
      sel.style.padding='7px 10px';
      sel.style.fontWeight='900';

      const opts = [
        {v:'pendente', t:'Pendente'},
        {v:'pago', t:'Pago'},
      ];
      opts.forEach(o=>{
        const op=document.createElement('option');
        op.value=o.v; op.textContent=o.t;
        if(o.v===atual || (atual==='' && o.v==='pendente')) op.selected=true;
        sel.appendChild(op);
      });

      el.parentNode.replaceChild(sel, el);
      sel.focus();

      async function salvar(){
        const sp = sel.value || 'pendente';
        const res = await salvarInlineEntrega(idEntrega, {status_pagamento: sp});
        const span = document.createElement('span');
        span.className='pagamento-editable';
        span.dataset.id=idEntrega;
        span.dataset.statusPagamento=sp;
        span.title='Clique para alterar o status do pagamento';
        span.innerHTML = makePillPagto(sp);
        sel.parentNode.replaceChild(span, sel);

        if(res && res.ok){
          showToast('<strong>Pagamento atualizado.</strong>');
        }else{
          showToast('<strong>N√£o foi poss√≠vel atualizar o pagamento agora.</strong>');
        }
      }

      sel.addEventListener('change', salvar);
      sel.addEventListener('blur', ()=> salvar(), {once:true});
    });

    async function salvarValorEntrega(idEntrega, novo){
      try{
        const r1 = await fetch(`/api/entregas/${idEntrega}/valor`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json','X-Requested-With':'fetch'},
          body: JSON.stringify({ valor: novo })
        });
        if(r1.ok) return true;
      }catch(e){}

      try{
        const fd = new FormData();
        fd.append('valor', novo);
        fd.append('valor_servico', novo);
        fd.append('atualizar_valor', '1');
        fd.append('notificar_painel', '1');

        const r2 = await fetch(`/editar_entrega/${idEntrega}`, {
          method:'POST',
          body: fd,
          headers:{'X-Requested-With':'fetch'}
        });
        if(r2.ok) return true;
      }catch(e){}

      return false;
    }

    document.addEventListener('click', (ev)=>{
      const el = ev.target.closest?.('.value-editable');
      if(!el) return;

      ev.preventDefault();
      ev.stopPropagation();

      const idEntrega = el.dataset?.id || '';
      if(!idEntrega) return;

      let valorAtual = el.dataset.valor || '';
      if(!valorAtual) valorAtual = String(parseNumberFromBRL(el.textContent || '')).toFixed(2);

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'value-input';
      input.inputMode = 'decimal';
      input.value = String(valorAtual).replace('.', ',');

      el.parentNode.replaceChild(input, el);
      input.focus();
      input.select();

      async function finalizar(shouldSave){
        const raw = (input.value || '').trim();
        let num = parseNumberFromBRL(raw);
        if(!Number.isFinite(num) || num <= 0) num = parseNumberFromBRL(valorAtual);
        const novo = num.toFixed(2);

        const span = document.createElement('span');
        span.className = 'value-editable';
        span.dataset.id = idEntrega;
        span.dataset.valor = novo;
        span.title = 'Clique para alterar o valor';
        span.textContent = formatBRLFromNumberLike(novo);

        input.parentNode.replaceChild(span, input);
        if(!shouldSave) return;

        const ok = await salvarValorEntrega(idEntrega, novo);
        if(ok){
          showToast('<strong>Valor atualizado.</strong>');
        }else{
          window.location.href = `/editar_entrega/${idEntrega}`;
        }
      }

      input.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){ e.preventDefault(); finalizar(true); }
        if(e.key === 'Escape'){ e.preventDefault(); finalizar(false); }
      });
      input.addEventListener('blur', ()=> finalizar(true), { once:true });
    });

    window.addEventListener('DOMContentLoaded', ()=>{
      const btnMenu   = document.getElementById('btnMenu');
      const sidePanel = document.getElementById('sidePanel');
      if (!btnMenu || !sidePanel) return;

      btnMenu.addEventListener('click', (e)=>{
        e.stopPropagation();
        const isOpen = sidePanel.classList.toggle('open');
        if(isOpen) btnMenu.classList.add('open'); else btnMenu.classList.remove('open');
      });

      document.addEventListener('click', (ev)=>{
        if (!sidePanel.classList.contains('open')) return;
        if (ev.target === btnMenu || btnMenu.contains(ev.target)) return;
        if (sidePanel.contains(ev.target)) return;
        sidePanel.classList.remove('open');
        btnMenu.classList.remove('open');
      });
    });

    (function(){
      const selCoop    = document.getElementById('cooperado-espera');
      const inpNome    = document.getElementById('nome-espera');
      const formEspera = document.getElementById('form-espera');

      if (selCoop && inpNome){
        selCoop.addEventListener('change', ()=>{
          const opt  = selCoop.options[selCoop.selectedIndex];
          const nome = opt ? (opt.text || '') : '';
          if (!inpNome.value) inpNome.value = nome;
        });
      }
      if (formEspera && selCoop && inpNome){
        formEspera.addEventListener('submit', ()=>{
          if (!inpNome.value) {
            const opt  = selCoop.options[selCoop.selectedIndex];
            const nome = opt ? (opt.text || '') : '';
            inpNome.value = nome;
          }
        });
      }
    })();

    (function(){
      const ulFila = document.getElementById('espera-lista');
      let dragEl = null;

      function renumerar(){
        const nums = ulFila ? ulFila.querySelectorAll('.espera-chip-num') : [];
        nums.forEach((el,i)=> el.textContent = i+1);
      }
      function salvarOrdem(){
        if(!ulFila) return;
        const ids = [].map.call(ulFila.querySelectorAll('.espera-chip'), li => li.dataset.id);
        fetch('/lista_espera/reordenar',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ordem:ids})
        }).catch(()=>{});
      }

      if(ulFila){
        ulFila.addEventListener('dragstart', (e)=>{
          const li = e.target.closest('.espera-chip');
          if(!li) return;
          dragEl = li;
          li.style.opacity = 0.6;
        });
        ulFila.addEventListener('dragend', (e)=>{
          const li = e.target.closest('.espera-chip');
          if(!li) return;
          li.style.opacity = 1;
          dragEl = null;
          salvarOrdem();
        });
        ulFila.addEventListener('dragover', (e)=>{
          e.preventDefault();
          const li = e.target.closest('.espera-chip');
          if(!li || li === dragEl) return;
          const r = li.getBoundingClientRect();
          const after = (e.clientY - r.top) > (r.height / 2);
          if(after) li.after(dragEl); else li.before(dragEl);
          renumerar();
        });
      }
    })();

    function atualizarOuInserirLinhaEntrega(dados){
      if (!dados?.id || !dados?.linha_html) return;
      const tbody = document.querySelector('.tabela tbody');
      if (!tbody) return;

      const temp = document.createElement('tbody');
      temp.innerHTML = dados.linha_html.trim();
      const novaTr = temp.querySelector('tr');
      if (!novaTr) return;

      const trExistente = tbody.querySelector('tr[data-id="' + dados.id + '"]');
      if (trExistente) tbody.replaceChild(novaTr, trExistente);
      else tbody.prepend(novaTr);

      atualizarBadgeAbertas();
    }
    function removerLinhaEntrega(id){
      const tbody = document.querySelector('.tabela tbody');
      if (!tbody || !id) return;
      const tr = tbody.querySelector('tr[data-id="' + id + '"]');
      if (tr) tr.remove();
      atualizarBadgeAbertas();
    }
    function atualizarFilaEsperaTempoReal(htmlLista){
      const ulFila = document.getElementById('espera-lista');
      if (!ulFila || !htmlLista) return;
      ulFila.innerHTML = htmlLista;
    }

    if (typeof socket !== 'undefined') {
      socket.on('entrega_criada', atualizarOuInserirLinhaEntrega);
      socket.on('entrega_atualizada', atualizarOuInserirLinhaEntrega);
      socket.on('entrega_excluida', (dados)=> dados?.id && removerLinhaEntrega(dados.id));
      socket.on('fila_espera_atualizada', (dados)=> dados?.html_lista && atualizarFilaEsperaTempoReal(dados.html_lista));
    }
  </script>

  <!-- CUPOM / MAPA TELA CHEIA -->
  <script>
    
    // ===== CUPOM: impress√£o sem pop-up (iframe) + op√ß√£o de editar =====
    var __cupomTmpDados = null;

    function __esc(s){
      return String(s ?? '').replace(/[&<>"']/g, function(m){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
      });
    }

    function __openCupomOverlay(){
      var ov = document.getElementById('cupomOverlay');
      if(!ov) return;
      ov.style.display = 'flex';
      document.body.classList.add('locked');
    }
    function __closeCupomOverlay(){
      var ov = document.getElementById('cupomOverlay');
      if(!ov) return;
      ov.style.display = 'none';
      document.body.classList.remove('locked');
      var form = document.getElementById('cupomEditForm');
      if(form) form.style.display = 'none';
    }

    function __showCupomEditForm(d){
      var form = document.getElementById('cupomEditForm');
      if(!form) return;
      form.style.display = 'block';

      var inpCliente = document.getElementById('cupomCliente');
      var inpColeta = document.getElementById('cupomColeta');
      var inpEntrega = document.getElementById('cupomEntrega');
      var inpAt = document.getElementById('cupomAtendente');

      var inpRec = document.getElementById('cupomRecebido');
      if(inpCliente) inpCliente.value = d?.cliente || '';
      if(inpColeta)  inpColeta.value  = d?.endereco || '';
      if(inpEntrega) inpEntrega.value = '';
      if(inpAt)      inpAt.value      = '';
      if(inpRec)     inpRec.value     = d?.recebido || '';
    }

    function __buildCupomHtml(d, mode, edits){
      edits = edits || {};
      var logoUrl = "/static/logo_coopex.png";
      var reviewUrl = "https://g.page/r/CY6ffwOT76pNEBM/review";

      // QR como IMAGEM (sem <script>) + fallback
      var qrPrimary = "https://quickchart.io/qr?size=220&text=" + encodeURIComponent(reviewUrl);
      var qrFallback = "https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=" + encodeURIComponent(reviewUrl);

      var cliente = (mode === 'editado') ? (edits.cliente || d.cliente) : d.cliente;
      var atendente = (mode === 'editado') ? (edits.atendente || '') : '';
      var recebido = (mode === 'editado') ? (edits.recebido || d.recebido || '') : (d.recebido || '');
      var coleta = (mode === 'editado') ? (edits.coleta || '') : '';
      var entrega = (mode === 'editado') ? (edits.entrega || '') : '';

      function row(label, value){
        return '<div class="row"><div class="k">'+ __esc(label) +'</div><div class="v">'+ __esc(value || '-') +'</div></div>';
      }

      var blocoEndereco = '';
      if(mode === 'editado'){
        blocoEndereco += row('COLETA:', coleta || '-');
        blocoEndereco += row('ENTREGA:', entrega || '-');
      }else{
        blocoEndereco += row('ENDERE√áO:', d.endereco || '-');
        blocoEndereco += row('BAIRRO:', d.bairro || '-');
      }

      var atendenteLinha = atendente ? row('ATENDENTE:', atendente) : '';
      var recebidoLinha = recebido ? row('RECEBIDO POR:', recebido) : '';

      // Layout 2 colunas (r√≥tulo esquerda / valor direita), com total bem alinhado
      var html =
        '<!doctype html><html><head><meta charset="utf-8">' +
        '<meta name="viewport" content="width=device-width, initial-scale=1">' +
        '<title>Cupom</title>' +
        '<style>' +
        'html,body{margin:0;padding:0;font-family:Arial,Helvetica,sans-serif; color:#000;}' +
        '.ticket{width:80mm; padding:6mm 5mm;}' +
        '.center{text-align:center;}' +
        '.logo{max-width:62mm; margin:0 auto 6px; display:block;}' +
        '.title{font-weight:800;font-size:16px;margin:2px 0;}' +
        '.sub{font-size:11px; opacity:.88;}' +
        '.hr{border-top:1px dashed #000; margin:8px 0;}' +
        '.row{display:flex; justify-content:space-between; gap:10px; font-size:12.5px; margin:3px 0;}' +
        '.k{font-weight:700; flex:0 0 auto;}' +
        '.v{font-weight:700; text-align:right; flex:1 1 auto; word-break:break-word;}' +
        '.totalRow{display:flex; justify-content:space-between; align-items:flex-end; margin-top:6px; font-size:15px; font-weight:800;}' +
        '.totalRow .v{font-size:16px;}' +
        '.small{font-size:11px; opacity:.9;}' +
        '.qrWrap{margin-top:10px; display:flex; flex-direction:column; align-items:center; gap:6px;}' +
        '.qrImg{width:38mm;height:38mm; object-fit:contain;}' +
        '</style></head><body>' +
        '<div class="ticket">' +
          '<div class="center">' +
            '<img class="logo" src="'+ logoUrl +'" alt="COOPEX">' +
            '<div class="title">CUPOM N√ÉO FISCAL</div>' +
            '<div class="sub">Comprovante de Entrega</div>' +
          '</div>' +
          '<div class="hr"></div>' +
          row('PEDIDO:', '#'+ (d.idPad || d.id || '-') ) +
          row('DATA:', d.data || '-') +
          row('HORA:', d.horaPedido || '-') +
          row('CLIENTE:', cliente || '-') +
          blocoEndereco +
          row('MOTOBOY:', d.cooperado || '-') +
          row('FORMA PGTO:', d.formaPgto || '-') +
          atendenteLinha +
          recebidoLinha +
          '<div class="hr"></div>' +
          '<div class="totalRow"><div class="k">TOTAL:</div><div class="v">R$ '+ __esc(d.valorFmt || d.valor || '-') +'</div></div>' +
          '<div class="hr"></div>' +
          '<div class="qrWrap">' +
            '<div class="small"><strong>Avalie no Google</strong></div>' +
            '<img class="qrImg" src="'+ qrPrimary +'" alt="QR Avalia√ß√£o" onerror="this.onerror=null;this.src=\''+ qrFallback +'\';">' +
            '<div class="small" style="text-align:center;">Obrigado por escolher a <strong>COOPEX</strong>!<br>Sua avalia√ß√£o ajuda nosso servi√ßo a melhorar.</div>' +
          '</div>' +
        '</div>' +
        '</body></html>';

      return html;
    }

    // Bot√£o na tabela chama isso
    function imprimirCupom(idEntrega, botao){
      try{
        if(!botao || !botao.dataset) return;

        var valorRaw = botao.dataset.valor || '-';
        var valorFmt = '-';
        try{
          var num = parseFloat(String(valorRaw).replace(',','.'));
          if(!isNaN(num)) valorFmt = num.toFixed(2).replace('.',',');
        }catch(e){}

        __cupomTmpDados = {
          id: botao.dataset.id || idEntrega || '-',
          idPad: botao.dataset.id || idEntrega || '-',
          cliente: botao.dataset.cliente || '-',
          bairro: botao.dataset.bairro || '-',
          endereco: botao.dataset.endereco || '-',
          valor: valorRaw,
          valorFmt: valorFmt,
          data: botao.dataset.data || '-',
          horaPedido: botao.dataset.hora_pedido || botao.dataset.horaPedido || '-',
          horaAtribuida: botao.dataset.hora_atribuida || botao.dataset.horaAtribuida || '-',
          cooperado: botao.dataset.cooperado || '-',
          formaPgto: botao.dataset.pagamento || botao.dataset.formaPgto || '-',
          recebido: botao.dataset.recebido || ''
        
        };

        __openCupomOverlay();
      }catch(e){
        console.error(e);
        alert('N√£o foi poss√≠vel preparar o cupom.');
      }
    }

    // Handlers do overlay (1x)
    window.addEventListener('DOMContentLoaded', function(){
      var btnNormal = document.getElementById('cupomPrintNormal');
      var btnEdit = document.getElementById('cupomEditFirst');
      var btnPrintEdited = document.getElementById('cupomPrintEdited');
      var btnCancelEdit = document.getElementById('cupomCancelEdit');
      var btnClose = document.getElementById('cupomClose');
      var ov = document.getElementById('cupomOverlay');

      if(btnClose) btnClose.addEventListener('click', __closeCupomOverlay);
      if(ov) ov.addEventListener('click', function(e){ if(e.target === ov) __closeCupomOverlay(); });

      if(btnNormal) btnNormal.addEventListener('click', function(){
        try{
          if(!__cupomTmpDados) return;
          var html = __buildCupomHtml(__cupomTmpDados, 'normal', {});
          if(window.__printHtmlTM20X) window.__printHtmlTM20X(html);
          __closeCupomOverlay();
        }catch(e){
          console.error(e);
          __closeCupomOverlay();
          alert('N√£o foi poss√≠vel imprimir.');
        }
      });

      if(btnEdit) btnEdit.addEventListener('click', function(){
        if(!__cupomTmpDados) return;
        __showCupomEditForm(__cupomTmpDados);
      });

      if(btnCancelEdit) btnCancelEdit.addEventListener('click', function(){
        var form = document.getElementById('cupomEditForm');
        if(form) form.style.display = 'none';
      });

      if(btnPrintEdited) btnPrintEdited.addEventListener('click', function(){
        try{
          if(!__cupomTmpDados) return;
          var edits = {
            cliente: (document.getElementById('cupomCliente')||{}).value || '',
            coleta: (document.getElementById('cupomColeta')||{}).value || '',
            entrega: (document.getElementById('cupomEntrega')||{}).value || '',
            atendente: (document.getElementById('cupomAtendente')||{}).value || '',
            recebido: (document.getElementById('cupomRecebido')||{}).value || ''
          };
          var html = __buildCupomHtml(__cupomTmpDados, 'editado', edits);
          if(window.__printHtmlTM20X) window.__printHtmlTM20X(html);
          __closeCupomOverlay();
        }catch(e){
          console.error(e);
          __closeCupomOverlay();
          alert('N√£o foi poss√≠vel imprimir.');
        }
      });
    });

function abrirMapaTelaCheia() {
      try {
        var url = "{{ url_for('mapa_motoboys') }}";
        var a = document.createElement('a');
        a.href = url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (e) {
        console.error(e);
        showToast('<strong>N√£o foi poss√≠vel abrir o mapa agora.</strong>');
      }
    }

    window.addEventListener('DOMContentLoaded', function(){
      var btnFull = document.getElementById('btnFullMap');
      if (btnFull) btnFull.addEventListener('click', abrirMapaTelaCheia);
    });
  </script>

  <!-- Leaflet -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

  <!-- MarkerCluster -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" crossorigin=""></script>

  <script>
    // ===== MAPA (SEM AGRUPAMENTO / COM LISTA + FILTRO) =====
    window.addEventListener('DOMContentLoaded', function(){
      var mapEl = document.getElementById('map-coopex');
      if (!mapEl || typeof L === 'undefined') return;

      var map = L.map('map-coopex', { zoomControl: true, preferCanvas: true }).setView([-5.7945, -35.211], 13);

      // Tile COLORIDO e mais est√°vel no Render
      var tile = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        maxZoom: 20,
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd'
      }).addTo(map);

      // for√ßa recalcular tamanho (muito comum o mapa nascer "travado")
      setTimeout(function(){ try{ map.invalidateSize(true); }catch(e){} }, 300);
      setTimeout(function(){ try{ map.invalidateSize(true); }catch(e){} }, 1200);

      // marcador fino e pequeno
      function makeMarker(lat, lng, tooltipHtml, online){
        var color = online ? '#16a34a' : '#ef4444';
        var m = L.circleMarker([lat,lng], {
          radius: 4,
          weight: 2,
          color: color,
          fillColor: color,
          fillOpacity: 0.85
        }).addTo(map);
        if (tooltipHtml){
          m.bindTooltip(tooltipHtml, {direction:'top', sticky:true});
        }
        return m;
      }

      var markers = {}; // id -> marker
      var lastData = [];
      var currentFilter = 'all';

      var selectedId = '';
      var userInteracted = false;
      var programmaticMove = false;

      // Se o admin mexer no mapa (zoom/arrastar), n√£o vamos mais resetar o zoom automaticamente
      map.on('zoomstart movestart', function(){
        if (!programmaticMove) userInteracted = true;
      });


      var sel = document.getElementById('mapSearch');
      var filterSel = document.getElementById('mapFilter');

      function isOnline(p){
        if (typeof p.online === 'boolean') return p.online;
        if (typeof p.is_online === 'boolean') return p.is_online;
        var s = String(p.status || '').toLowerCase();
        return (s.includes('online') || s.includes('livre') || s.includes('corrida'));
      }

      function renderList(list){
        if (!sel) return;
        var keep = sel.value;
        sel.innerHTML = '<option value="">üîç Localizar motoboy‚Ä¶</option>';
        list.forEach(function(p){
          var opt = document.createElement('option');
          opt.value = String(p.id);
          opt.textContent = p.nome || ('Motoboy ' + p.id);
          sel.appendChild(opt);
        });
        // mant√©m sele√ß√£o se ainda existir
        if (keep && Array.from(sel.options).some(function(o){ return o.value === keep; })){
          sel.value = keep;
        }
      }

      function renderMarkers(list){
        var seen = new Set();

        list.forEach(function(p){
          var lat = p.lat, lng = p.lng;
          if (typeof lat !== 'number' || typeof lng !== 'number') return;

          seen.add(String(p.id));

          var online = isOnline(p);
          var statusTxt = online ? 'ONLINE' : 'OFFLINE';
          var html = '<b>'+ (p.nome||'') +'</b>'
                   + '<br><span style="font-weight:800">'+statusTxt+'</span>'
                   + (p.ultima_atualizacao ? '<br><span style="opacity:.9">'+p.ultima_atualizacao+'</span>' : '')
                   + (p.endereco ? '<br><span style="opacity:.9">'+p.endereco+'</span>' : '');

          if (!markers[String(p.id)]){
            markers[String(p.id)] = makeMarker(lat, lng, html, online);
          } else {
            markers[String(p.id)].setLatLng([lat,lng]);
            markers[String(p.id)].setStyle({
              color: online ? '#16a34a' : '#ef4444',
              fillColor: online ? '#16a34a' : '#ef4444'
            });
            try{ markers[String(p.id)].setTooltipContent(html); }catch(e){}
          }
        });

        // remove marcadores que sumiram
        Object.keys(markers).forEach(function(k){
          if(!seen.has(k)){
            try{ map.removeLayer(markers[k]); }catch(e){}
            delete markers[k];
          }
        });

        // se n√£o tem sele√ß√£o, ajusta bounds (sem ficar pulando com zoom alto)
        try{
          if (list.length && (!sel || !sel.value)){
            var pts = list
              .filter(function(p){ return (typeof p.lat==='number' && typeof p.lng==='number'); })
              .map(function(p){ return [p.lat, p.lng]; });
            if (pts.length && !selectedId && !userInteracted){
              map.fitBounds(pts, {padding:[30,30], maxZoom: 14});
            }
          }
        }catch(e){}

        setTimeout(function(){ try{ map.invalidateSize(true); }catch(e){} }, 50);
      }

      function applyFilterAndRender(){
        var list = lastData.slice();
        if (currentFilter === 'online'){
          list = list.filter(isOnline);
        }
        renderList(list);
        renderMarkers(list);
      }

      if (filterSel){
        filterSel.addEventListener('change', function(){
          currentFilter = filterSel.value || 'all';
          applyFilterAndRender();
        });
      }

      if (sel){
        sel.addEventListener('change', function(){
          var id = sel.value;
          selectedId = id || '';
          if (!id) return;
          programmaticMove = true;
          var p = lastData.find(function(x){ return String(x.id) === String(id); });
          if (!p || typeof p.lat !== 'number' || typeof p.lng !== 'number') return;

          try{
            map.setView([p.lat, p.lng], 16);
            if (markers[String(p.id)]){
              try{ markers[String(p.id)].openTooltip(); }catch(e){}
            }
          }catch(e){}
        });
      }


      // Bot√£o: mapa em tela cheia (tenta Fullscreen API; se falhar, usa CSS fullscreen)
      var fullBtn = document.getElementById('btnFullMap');
      function toggleFull(){
        try{
          var card = mapEl.closest('.map-card') || mapEl.parentElement;
          if (!card) card = mapEl;
          var goFull = !document.fullscreenElement;
          if (goFull){
            if (card.requestFullscreen){
              card.requestFullscreen().then(function(){
                setTimeout(function(){ try{ map.invalidateSize(true); }catch(e){} }, 400);
              }).catch(function(){
                card.classList.add('fullscreen');
                setTimeout(function(){ try{ map.invalidateSize(true); }catch(e){} }, 200);
              });
            }else{
              card.classList.add('fullscreen');
              setTimeout(function(){ try{ map.invalidateSize(true); }catch(e){} }, 200);
            }
          }else{
            if (document.exitFullscreen){
              document.exitFullscreen().catch(function(){});
            }
            card.classList.remove('fullscreen');
            setTimeout(function(){ try{ map.invalidateSize(true); }catch(e){} }, 200);
          }
        }catch(e){}
      }
      if (fullBtn){
        fullBtn.addEventListener('click', function(ev){
          ev.preventDefault();
          toggleFull();
        });
      }
      document.addEventListener('fullscreenchange', function(){
        try{ setTimeout(function(){ map.invalidateSize(true); }, 200); }catch(e){}
      });

      async function atualizar(){
        try{
          const r = await fetch('{{ url_for("mapa_motoboys") }}?format=json', {
            cache:'no-store',
            headers:{'X-Requested-With':'fetch', 'Accept':'application/json'}
          });
          if(!r.ok) return;
          const data = await r.json();
          if(!Array.isArray(data)) return;
          lastData = data;
          applyFilterAndRender();
        }catch(e){}
      }

      atualizar();
      setInterval(atualizar, 5000);
    });
  </script>

  <!-- SOCORRO (√°udio) -->
  <audio id="socorroAudio" src="{{ url_for('static', filename='socorro.mp3') }}" preload="auto"></audio>
  <script>
    (function socorroPolling(){
      const audio = document.getElementById('socorroAudio');
      async function check(){
        try{
          const r = await fetch('{{ url_for("admin_novo_socorro") }}', {cache:'no-store'});
          if(!r.ok) return;
          const data = await r.json();
          if(data && data.novo){
            try{ if(audio){ audio.currentTime = 0; audio.play(); } }catch(e){}
            try{
              showToast('<strong>‚ö†Ô∏è SOCORRO:</strong> '+(data.cooperado||'')+' ‚Äî '+(data.mensagem||''));
            }catch(e){}
          }
        }catch(e){}
      }
      check();
      setInterval(check, 4000);
    })();
  </script>


  <!-- SOCORRO (persistente at√© clicar no X) -->
  <div id="socorro-bar" style="display:none" class="socorro-bar" role="alert" aria-live="assertive">
    <div class="socorro-left">
      <div class="socorro-title">‚ö†Ô∏è SOCORRO <span id="socorro-count" class="socorro-count">0</span></div>
      <div id="socorro-msg" class="socorro-msg"></div>
    </div>
    <button id="socorro-x" class="socorro-x" type="button" title="Marcar como lido">√ó</button>
  </div>

  <script>
    (function socorroPollingReal(){
      const audio = document.getElementById('som-socorro') || document.getElementById('socorroAudio') || document.getElementById('som-pendente');
      const bar = document.getElementById('socorro-bar');
      const msgEl = document.getElementById('socorro-msg');
      const countEl = document.getElementById('socorro-count');
      const btnX = document.getElementById('socorro-x');

      let currentId = null;
      let lastPlayedId = null;

      function show(data){
        if(!bar || !msgEl || !countEl) return;
        bar.style.display = 'flex';
        countEl.textContent = String(data.count || 0);
        msgEl.textContent = (data.cooperado||'') + ' ‚Äî ' + (data.mensagem||'') + (data.momento ? (' ¬∑ ' + data.momento) : '');
      }
      function hide(){
        if(!bar) return;
        bar.style.display = 'none';
        if(msgEl) msgEl.textContent = '';
        if(countEl) countEl.textContent = '0';
      }

      async function check(){
        try{
          const r = await fetch('{{ url_for("admin_novo_socorro") }}', {cache:'no-store'});
          if(!r.ok) return;
          const data = await r.json();
          if(data && data.novo){
            currentId = data.id || null;
            show(data);

            if(currentId && currentId !== lastPlayedId){
              lastPlayedId = currentId;
              try{ if(audio){ audio.currentTime = 0; audio.play(); } }catch(e){}
            }
          }else{
            currentId = null;
            hide();
          }
        }catch(e){}
      }

      if(btnX){
        btnX.addEventListener('click', async ()=>{
          if(!currentId) return;
          try{
            const r = await fetch('{{ url_for("admin_socorro_marcar_lido") }}', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({id: currentId})
            });
            if(r.ok){
              await check();
            }
          }catch(e){}
        });
      }

      check();
      setInterval(check, 4000);
    })();
  </script>



  <!-- CUPOM: Overlay de escolha/edi√ß√£o (n√£o salva no banco, s√≥ imprime) -->
  <div id="cupomOverlay" style="display:none;">
    <div class="cupom-modal" role="dialog" aria-modal="true" aria-label="Imprimir cupom">
      <div class="cupom-head">
        <strong>Imprimir Cupom</strong>
        <button type="button" class="cupom-x" id="cupomClose" aria-label="Fechar">√ó</button>
      </div>

      <div class="cupom-body">
        <div class="cupom-actions">
          <button type="button" class="btn" id="cupomPrintNormal">Imprimir normal</button>
          <button type="button" class="btn alt" id="cupomEditFirst">Editar antes</button>
        </div>

        <form id="cupomEditForm" style="display:none; margin-top:12px;">
          <div class="cupom-grid">
            <div class="field">
              <label>Cliente</label>
              <input type="text" id="cupomCliente" placeholder="Nome do cliente" />
            </div>
            <div class="field">
              <label>Atendente</label>
              <input type="text" id="cupomAtendente" placeholder="Seu nome (atendente)" />
            </div>
            <div class="field">
              <label>Quem recebeu</label>
              <input type="text" id="cupomRecebido" placeholder="Nome de quem recebeu" />
            </div>
            <div class="field" style="grid-column:1/-1;">
              <label>Coleta (endere√ßo)</label>
              <input type="text" id="cupomColeta" placeholder="Endere√ßo de coleta" />
            </div>
            <div class="field" style="grid-column:1/-1;">
              <label>Entrega (endere√ßo)</label>
              <input type="text" id="cupomEntrega" placeholder="Endere√ßo de entrega" />
            </div>
          </div>

          <div class="cupom-actions" style="margin-top:12px;">
            <button type="button" class="btn" id="cupomPrintEdited">Imprimir (editado)</button>
            <button type="button" class="btn alt" id="cupomCancelEdit">Cancelar edi√ß√£o</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <style>
    #cupomOverlay{
      position:fixed; inset:0;
      background:rgba(8,12,24,.78);
      backdrop-filter: blur(3px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99999;
      padding:14px;
    }
    .cupom-modal{
      width:min(560px, 96vw);
      background:var(--card);
      color:var(--ink);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .cupom-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      background:linear-gradient(90deg, rgba(9, 33, 120, .98), rgba(15,53,181,.95));
      color:#fff;
      border-bottom:1px solid rgba(255,255,255,.18);
    }
    .cupom-x{
      width:38px;height:38px;border-radius:12px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.12);
      color:#fff;font-size:22px;font-weight:900;
      cursor:pointer;
    }
    .cupom-body{ padding:14px; }
    .cupom-actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .cupom-actions .btn{ flex:1 1 180px; justify-content:center; box-shadow:none; border:1px solid rgba(15,53,181,.20); }
    .cupom-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width:520px){ .cupom-grid{ grid-template-columns:1fr; } }
  </style>

<script id="tm20x_iframe_printer">
  // Impress√£o TM-T20X 80mm via IFRAME (n√£o usa pop-up)
  window.__printHtmlTM20X = window.__printHtmlTM20X || function(htmlDoc){
    try{
      var iframe = document.getElementById('tm20x_print_iframe');
      if(!iframe){
        iframe = document.createElement('iframe');
        iframe.id = 'tm20x_print_iframe';
        iframe.style.position='fixed';
        iframe.style.right='0';
        iframe.style.bottom='0';
        iframe.style.width='0';
        iframe.style.height='0';
        iframe.style.border='0';
        iframe.style.opacity='0';
        iframe.style.pointerEvents='none';
        document.body.appendChild(iframe);
      }

      // Evita travar rolagem caso algum modal tenha deixado body.locked
      document.body.classList.remove('locked');

      iframe.onload = null; // reset
      iframe.onload = function(){
        try{
          var w = iframe.contentWindow;
          var d = iframe.contentDocument || w.document;

          // Esperar imagens (logo/QR) carregarem antes de imprimir
          var imgs = Array.from(d.images || []);
          if(!imgs.length){
            setTimeout(function(){ try{ w.focus(); w.print(); }catch(e){ console.error(e); alert('Falha ao imprimir.'); } }, 120);
            return;
          }

          var done = 0;
          function finish(){
            // pequeno delay para layout estabilizar
            setTimeout(function(){
              try{ w.focus(); w.print(); }catch(e){ console.error(e); alert('Falha ao imprimir.'); }
            }, 180);
          }
          function mark(){
            done++;
            if(done >= imgs.length) finish();
          }
          imgs.forEach(function(img){
            if(img.complete) return mark();
            img.addEventListener('load', mark, {once:true});
            img.addEventListener('error', mark, {once:true});
          });

          // fallback: imprime mesmo assim depois de 1.2s
          setTimeout(function(){
            if(done < imgs.length) finish();
          }, 1200);

        }catch(e){
          console.error(e);
          try{
            var w2 = iframe.contentWindow;
            setTimeout(function(){ try{ w2.focus(); w2.print(); }catch(_){} }, 200);
          }catch(_){}
        }
      };

      var w = iframe.contentWindow;
      var d = iframe.contentDocument || w.document;
      d.open(); d.write(htmlDoc); d.close();

      // se onload n√£o disparar por algum motivo
      setTimeout(function(){
        try{
          var w3 = iframe.contentWindow;
          if(w3 && w3.document && w3.document.readyState === 'complete'){
            // trigger manual
            iframe.onload && iframe.onload();
          }
        }catch(e){}
      }, 300);

    }catch(e){
      console.error(e);
      alert('Erro ao imprimir o cupom.');
    }
  };
</script>

</body>
</html>
