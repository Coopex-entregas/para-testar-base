<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Mapa de Motoboys - Coopex</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />

    <style>
        :root {
            --azul: #0045a5;
            --azul-escuro: #002b66;
            --cinza-claro: #f4f4f4;
            --cinza-medio: #e0e0e0;
            --verde: #2ecc71;
            --laranja: #f39c12;
            --vermelho: #e74c3c;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f8f9fb;
            color: #222;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: linear-gradient(90deg, var(--azul-escuro), var(--azul));
            color: #fff;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .topbar-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .pill {
            font-size: 0.75rem;
            background: rgba(255,255,255,0.18);
            padding: 2px 8px;
            border-radius: 999px;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            border: none;
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 0.8rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s ease;
            background: rgba(255,255,255,0.92);
            color: #222;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }

        .btn span.icon { font-size: 1rem; }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            background: #fff;
        }

        .btn-primary {
            background: #fff;
            color: var(--azul-escuro);
            font-weight: 600;
        }

        .btn-primary:hover { background: #f5f7ff; }

        .layout {
            display: flex;
            height: calc(100vh - 52px);
        }

        #map {
            flex: 1.7;
            height: 100%;
            background: #e5e7eb; /* cinza de fundo pra n√£o ficar branco */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            color: #555;
        }

        .sidebar {
            flex: 1;
            max-width: 380px;
            min-width: 260px;
            border-left: 1px solid var(--cinza-medio);
            background: #ffffff;
            display: flex;
            flex-direction: column;
            padding: 10px 12px;
            gap: 10px;
        }

        .sidebar-header {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-title {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .search-row {
            display: flex;
            gap: 6px;
        }

        .search-row input {
            flex: 1;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--cinza-medio);
            font-size: 0.85rem;
        }

        .badges-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 2px;
        }

        .badge-filter {
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--cinza-medio);
            font-size: 0.7rem;
            cursor: pointer;
            background: #fafafa;
        }

        .badge-filter.active {
            background: var(--azul);
            color: #fff;
            border-color: var(--azul);
        }

        .legend-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.75rem;
            margin-top: 4px;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .list {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
        }

        .motoboy-card {
            border-radius: 10px;
            border: 1px solid #eeeeee;
            padding: 8px 10px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: background 0.12s ease, box-shadow 0.12s ease, transform 0.08s ease;
        }

        .motoboy-card:hover {
            background: #f7f9ff;
            box-shadow: 0 1px 5px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }

        .motoboy-card-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 6px;
        }

        .motoboy-name {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .motoboy-status-pill {
            font-size: 0.7rem;
            border-radius: 999px;
            padding: 2px 8px;
            color: #fff;
        }

        .status-livre { background: var(--verde); }
        .status-em_corrida { background: var(--laranja); }
        .status-offline { background: #7f8c8d; }

        .motoboy-sub {
            font-size: 0.75rem;
            color: #666;
            margin-top: 2px;
        }

        .motoboy-meta {
            font-size: 0.7rem;
            color: #999;
            margin-top: 2px;
        }

        .empty-state {
            font-size: 0.8rem;
            color: #777;
            text-align: center;
            margin-top: 18px;
        }

        @media (max-width: 900px) {
            .layout { flex-direction: column; }
            #map { height: 55vh; }
            .sidebar {
                max-width: 100%;
                border-left: none;
                border-top: 1px solid var(--cinza-medio);
                height: 45vh;
            }
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="topbar-left">
            <div class="topbar-title">Mapa de Motoboys - Coopex</div>
            <div class="pill">Visualiza√ß√£o em tempo (quase) real</div>
        </div>
        <div class="topbar-right">
            <button class="btn btn-primary" id="btnFitBounds">
                <span class="icon">üó∫Ô∏è</span>
                Enquadrar todos
            </button>
            <button class="btn" onclick="window.close()">
                <span class="icon">‚úñ</span>
                Fechar aba
            </button>
        </div>
    </div>

    <div class="layout">
        <div id="map">Carregando mapa...</div>

        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Motoboys conectados</div>
                <div class="search-row">
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Buscar por nome..."
                        autocomplete="off">
                </div>
                <div class="badges-row">
                    <button class="badge-filter active" data-status="todos">Todos</button>
                    <button class="badge-filter" data-status="livre">Livres</button>
                    <button class="badge-filter" data-status="em_corrida">Em corrida</button>
                    <button class="badge-filter" data-status="offline">Offline</button>
                </div>
                <div class="legend-row">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--verde);"></div> Livre
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--laranja);"></div> Em corrida
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #7f8c8d;"></div> Offline
                    </div>
                </div>
            </div>

            <div class="list" id="motoboysList"></div>
        </aside>
    </div>

    <!-- Leaflet JS (1¬∫ tentativa) -->
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin="">
    </script>

    <script>
        // Dados vindos do Flask
        const motoboys = {{ (motoboys_js or []) | tojson | safe }};
        const motoboysArray = Array.isArray(motoboys) ? motoboys : [];

        const STATUS_CONFIG = {
            "livre":      { label: "Livre",      color: "#2ecc71" },
            "em_corrida": { label: "Em corrida", color: "#f39c12" },
            "offline":    { label: "Offline",    color: "#7f8c8d" }
        };

        function normalizarTexto(texto) {
            return (texto || '')
                .toString()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase();
        }

        function initMapa() {
            const mapDiv = document.getElementById('map');

            if (typeof L === 'undefined') {
                mapDiv.textContent = 'Erro ao carregar biblioteca de mapas (Leaflet). Veja o console do navegador (F12 > Console).';
                console.error('Leaflet (L) n√£o est√° definido.');
                return;
            }

            // Limpa mensagem de "carregando"
            mapDiv.textContent = '';

            const defaultCenter = [-5.79448, -35.211]; // Natal/RN
            const map = L.map('map').setView(defaultCenter, 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
            }).addTo(map);

            const markersById = {};
            const bounds = L.latLngBounds();

            motoboysArray.forEach(m => {
                if (typeof m.lat !== 'number' || typeof m.lng !== 'number') return;

                const statusCfg = STATUS_CONFIG[m.status] || STATUS_CONFIG['offline'];

                const marker = L.circleMarker([m.lat, m.lng], {
                    radius: 9,
                    stroke: true,
                    weight: 2,
                    color: '#ffffff',
                    fillColor: statusCfg.color,
                    fillOpacity: 0.95
                });

                const popupHtml = `
                    <div style="min-width: 180px;">
                        <strong>${m.nome || 'Motoboy'}</strong><br>
                        <small>Status: ${statusCfg.label}</small><br>
                        ${m.ultima_atualizacao ? `<small>√öltima atualiza√ß√£o: ${m.ultima_atualizacao}</small><br>` : ''}
                        ${m.endereco ? `<small>Zona: ${m.endereco}</small><br>` : ''}
                        ${m.observacao ? `<small>Obs: ${m.observacao}</small>` : ''}
                    </div>
                `;
                marker.bindPopup(popupHtml);
                marker.addTo(map);

                markersById[m.id] = marker;
                bounds.extend(marker.getLatLng());
            });

            function fitToMotoboys() {
                if (motoboysArray.length === 0 || bounds.isValid() === false) {
                    map.setView(defaultCenter, 12);
                } else {
                    map.fitBounds(bounds.pad(0.2));
                }
            }

            document.getElementById('btnFitBounds')
                .addEventListener('click', fitToMotoboys);

            fitToMotoboys();

            // ==== Lista / filtros ====
            const listEl = document.getElementById('motoboysList');
            const searchInput = document.getElementById('searchInput');
            const filterButtons = document.querySelectorAll('.badge-filter');

            let currentStatusFilter = 'todos';
            let currentSearch = '';

            function renderList() {
                listEl.innerHTML = '';
                const searchNorm = normalizarTexto(currentSearch);
                let count = 0;

                motoboysArray.forEach(m => {
                    if (currentStatusFilter !== 'todos' && m.status !== currentStatusFilter) return;
                    const nomeNorm = normalizarTexto(m.nome);
                    if (searchNorm && !nomeNorm.includes(searchNorm)) return;

                    count++;
                    const statusCfg = STATUS_CONFIG[m.status] || STATUS_CONFIG['offline'];
                    const statusClass = `status-${m.status || 'offline'}`;

                    const card = document.createElement('div');
                    card.className = 'motoboy-card';
                    card.dataset.id = m.id;

                    card.innerHTML = `
                        <div class="motoboy-card-header">
                            <div class="motoboy-name">${m.nome || 'Motoboy'}</div>
                            <div class="motoboy-status-pill ${statusClass}">
                                ${statusCfg.label}
                            </div>
                        </div>
                        <div class="motoboy-sub">
                            ${m.endereco ? m.endereco : 'Sem endere√ßo definido'}
                        </div>
                        <div class="motoboy-meta">
                            ${m.ultima_atualizacao ? `√öltima atualiza√ß√£o: ${m.ultima_atualizacao}` : ''}
                            ${m.observacao ? ` &middot; ${m.observacao}` : ''}
                        </div>
                    `;

                    card.addEventListener('click', () => {
                        const marker = markersById[m.id];
                        if (marker) {
                            const latLng = marker.getLatLng();
                            map.setView(latLng, 16, { animate: true });
                            marker.openPopup();
                        }
                    });

                    listEl.appendChild(card);
                });

                if (count === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'empty-state';
                    empty.textContent = 'Nenhum motoboy encontrado para esse filtro.';
                    listEl.appendChild(empty);
                }
            }

            renderList();

            searchInput.addEventListener('input', (e) => {
                currentSearch = e.target.value;
                renderList();
            });

            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentStatusFilter = btn.dataset.status;
                    renderList();
                });
            });
        }

        // IIFE com fallback de CDN
        (function () {
            if (typeof L !== 'undefined') {
                // Leaflet j√° carregou da primeira tag <script>
                initMapa();
            } else {
                console.warn('Leaflet n√£o dispon√≠vel via unpkg, tentando carregar via cdnjs...');
                const fallback = document.createElement('script');
                fallback.src = "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js";
                fallback.onload = initMapa;
                fallback.onerror = function () {
                    const mapDiv = document.getElementById('map');
                    mapDiv.textContent = 'N√£o foi poss√≠vel carregar o mapa (falha em ambos CDNs).';
                };
                document.head.appendChild(fallback);
            }
        })();
    </script>
</body>
</html>
