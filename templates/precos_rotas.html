<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>COOPEX ‚Äî Tabela de Pre√ßos & Rotas</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Fonte -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --royal:#4169E1; --royal-700:#3158d7;
      --ink:#0b1220; --muted:#5b677a; --bg:#f6f8ff;
      --panel:#ffffff; --panel-2:#f1f5ff; --border:#e6edff;
      --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
      --shadow:0 16px 40px rgba(49,88,215,.14), 0 6px 14px rgba(49,88,215,.08);
      --shadow-soft:0 10px 28px rgba(0,0,0,.06);
      --table-head:#eef4ff; --table-head-text:#1f2a44;
      --map-stroke:#1f77b4; --origin:#10b981; --dest:#ef4444;
      --radius:16px;
    }
    @media (prefers-color-scheme: dark){
      :root:not([data-theme-forced="light"]){
        --bg:#0b0f17; --panel:#0f1623; --panel-2:#0b1320; --border:#1d2636;
        --ink:#e7edf9; --muted:#8aa0c7; --table-head:#0b1320; --table-head-text:#b9ccff;
        --shadow:0 12px 28px rgba(0,0,0,.45);
      }
    }
    body.dark :root, :root[data-theme-forced="dark"]){
      --bg:#0b0f17; --panel:#0f1623; --panel-2:#0b1320; --border:#1d2636;
      --ink:#e7edf9; --muted:#8aa0c7; --table-head:#0b1320; --table-head-text:#b9ccff;
      --shadow:0 12px 28px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14.5px/1.55 Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--royal);text-decoration:none}

    /* Header */
    header{
      position:sticky; top:0; z-index:40;
      background:linear-gradient(90deg,var(--royal), #6ea1ff);
      color:#fff; box-shadow:var(--shadow);
      border-bottom:1px solid rgba(255,255,255,.12)
    }
    .wrap{max-width:1240px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center}
    .logo{width:34px;height:34px;border-radius:12px;background:conic-gradient(from 210deg,var(--royal),#6ea1ff,var(--royal));box-shadow:0 6px 16px rgba(65,105,225,.25)}

    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:linear-gradient(180deg,#fff,#f6f9ff);cursor:pointer;box-shadow:var(--shadow-soft);transition:transform .04s}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg,var(--royal),var(--royal-700));border-color:transparent;color:#fff;box-shadow:0 10px 24px rgba(65,105,225,.35)}
    .btn.link{background:transparent;border-color:rgba(255,255,255,.35);color:#fff}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.12);backdrop-filter:blur(6px)}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0f172a;color:#fff}

    /* Layout */
    .layout{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 64px)}
    @media (max-width:1100px){.layout{grid-template-columns:1fr}}
    .sidebar{position:sticky;top:64px;height:calc(100vh - 64px);background:var(--panel);border-right:1px solid var(--border);overflow:auto}
    .nav{padding:12px}
    .nav a{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;border:1px solid transparent;color:inherit}
    .nav a.active,.nav a:hover{background:var(--panel-2);border-color:var(--border)}
    .content{padding:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:1020px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}
    label{display:block;margin:6px 0 4px;color:var(--muted);font-weight:600}
    input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--ink)}
    input:focus,select:focus{outline:3px solid rgba(65,105,225,.22)}
    .table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:14px;overflow:hidden;background:var(--panel)}
    .table th,.table td{padding:12px;border-bottom:1px solid var(--border);text-align:left}
    .table th{background:var(--table-head);color:var(--table-head-text);font-weight:800}

    #map{width:100%;min-height:420px;height:52vh;border-radius:16px;border:1px solid var(--border);box-shadow:var(--shadow)}
    .legend{display:flex;gap:10px;align-items:center}
    .legend .dot{width:12px;height:12px;border-radius:999px;display:inline-block}

    .section{display:none}
    .section.active{display:block}

    .toast{
      position:fixed;right:16px;bottom:16px;background:#0f172a;color:#fff;padding:10px 14px;border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.3);opacity:0;transform:translateY(8px);transition:.2s;z-index:99
    }
    .toast.show{opacity:1;transform:translateY(0)}

    /* Badges */
    .badge-ok{background:#16a34a1a;color:#16a34a}
    .badge-warn{background:#f59e0b1a;color:#b45309}
    .badge-danger{background:#ef44441a;color:#b91c1c}

    /* Painel Street View (Mapillary) */
    .street-panel{
      position:fixed; top:64px; right:12px; width:420px; max-width:95vw; height:60vh; z-index:50;
      background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); display:none;
      overflow:hidden;
    }
    .street-panel header{background:var(--panel-2); color:inherit; box-shadow:none; border-bottom:1px solid var(--border);}
    .street-panel .bar{display:flex; align-items:center; gap:8px; padding:8px 10px;}
    .street-panel button{border-radius:10px}
    .street-iframe{width:100%; height:calc(60vh - 50px); border:0}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <i class="logo" aria-hidden="true"></i>

      <a class="btn link" href="{{ url_for('admin') }}">‚Üê Voltar ao Admin</a>

      <div class="pill" aria-label="Ajuste de valor por km">
        <span style="opacity:.95">R$ por km</span>
        <!-- texto preto em qualquer tema -->
        <input id="perKm" type="text" inputmode="decimal"
               style="width:110px;background:#fff;color:#111;border:0;border-radius:10px;padding:6px 8px"
               value="{{ '%.2f' % per_km }}"/>
        <button class="btn primary" id="savePerKm" title="Salvar valor por km">Salvar</button>
      </div>

      <span class="chip" title="Total de registros cadastrados">Registros: <strong id="statTotal">0</strong></span>
      <span class="chip" title="Bairros presentes nos registros">Bairros: <strong id="statBairros">0</strong></span>

      <div style="margin-left:auto"></div>
      <button id="btnTheme" class="btn" title="Alternar tema">Tema: auto</button>
    </div>
  </header>

  <!-- IMPORTANTE: n√£o colocar coment√°rios HTML dentro desta tag -->
  <div class="layout"
       data-end-list="{{ url_for('api_list_precos') }}"
       data-end-upsert="{{ url_for('api_upsert_preco') }}"
       data-end-delete="{{ url_for('api_delete_preco', item_id=0)[:-1] }}"
       data-end-ajustes="{{ url_for('api_ajustes') }}"
       data-end-perkm="{{ url_for('api_per_km') }}">

    <aside class="sidebar">
      <nav class="nav" aria-label="Navega√ß√£o">
        <a href="#tab-consulta" data-gotab class="active">Consultar por Bairros</a>
        <a href="#tab-endereco" data-gotab>Endere√ßo/CEP (Rotas)</a>
        <a href="#tab-cadastro" data-gotab>Cadastrar/Editar</a>
        <a href="#tab-ajustes" data-gotab>Ajustes em Massa</a>
        <a href="#tab-dados" data-gotab>Dados</a>
        <a href="#tab-testes" data-gotab>Testes</a>
      </nav>
    </aside>

    <main class="content">
      <!-- CONSULTA -->
      <section id="tab-consulta" class="card section active">
        <h2 style="margin:0 0 8px">Consultar pre√ßo cadastrado</h2>
        <div class="grid cols-3">
          <div>
            <label>Origem (bairro)</label>
            <input list="dl-bairros" id="qOrigem" placeholder="Ex.: Lagoa Nova"/>
          </div>
          <div>
            <label>Destino (bairro)</label>
            <input list="dl-bairros" id="qDestino" placeholder="Ex.: Tirol"/>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn primary" id="btnConsultar">Consultar</button>
          </div>
        </div>
        <div class="card" style="margin-top:8px;background:var(--panel-2)">
          <div style="display:flex;gap:10px;align-items:center">
            <div class="grow">
              <div style="color:var(--muted)">Resultado</div>
              <div id="consultaResultado" style="font-size:28px;font-weight:800">‚Äî</div>
            </div>
            <span class="chip" id="consultaStatus">sem consulta</span>
          </div>
        </div>
      </section>

      <!-- ROTAS -->
      <section id="tab-endereco" class="card section">
        <h2 style="margin:0 0 8px">C√°lculo por Endere√ßo/CEP (rota)</h2>
        <div class="grid cols-2">
          <div class="card" style="box-shadow:none">
            <label>CEP</label>
            <input id="cepOrigem" placeholder="Ex.: 59064-050" inputmode="numeric"/>
            <label style="margin-top:8px">Origem (auto-completar)</label>
            <input id="endOrigem" placeholder="Rua, n√∫mero, bairro, cidade"/>
            <div id="sugOrigem" class="card" style="display:none;margin-top:8px"></div>
          </div>
          <div class="card" style="box-shadow:none">
            <label>CEP</label>
            <input id="cepDestino" placeholder="Ex.: 59020-000" inputmode="numeric"/>
            <label style="margin-top:8px">Destino (auto-completar)</label>
            <input id="endDestino" placeholder="Rua, n√∫mero, bairro, cidade"/>
            <div id="sugDestino" class="card" style="display:none;margin-top:8px"></div>
          </div>
        </div>

        <div id="map" class="card" style="margin:10px 0; position:relative"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
          <button class="btn primary" id="btnCalcularKm">Calcular rota</button>
          <button class="btn" id="btnInverter">Inverter endere√ßos</button>
          <button class="btn" id="btnStreet">Explorar rua (clique no mapa)</button>
        </div>

        <div class="grid cols-3">
          <div class="card" style="box-shadow:none">
            <label>Dist√¢ncia (km)</label>
            <input id="outKm" readonly>
          </div>
          <div class="card" style="box-shadow:none">
            <label>Valor por km (R$)</label>
            <input id="outPerKm" type="text" inputmode="decimal">
          </div>
          <div class="card" style="box-shadow:none">
            <label>Pre√ßo estimado (R$)</label>
            <input id="outPreco" readonly>
          </div>
        </div>
      </section>

      <!-- CADASTRAR / EDITAR -->
      <section id="tab-cadastro" class="card section">
        <h2 style="margin:0 0 8px">Cadastrar/editar combina√ß√£o</h2>
        <div class="grid cols-3">
          <div>
            <label>Origem (bairro)</label>
            <input list="dl-bairros" id="cOrigem" placeholder="Ex.: Lagoa Nova">
          </div>
          <div>
            <label>Destino (bairro)</label>
            <input list="dl-bairros" id="cDestino" placeholder="Ex.: Tirol">
          </div>
          <div>
            <label>Valor (R$)</label>
            <input id="cValor" type="text" inputmode="decimal" placeholder="Ex.: 12,00">
          </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
          <button class="btn primary" id="btnSalvar">Salvar / Atualizar</button>
          <button class="btn" id="btnLimpar">Limpar</button>
        </div>

        <div style="display:flex;gap:10px;align-items:center;margin:14px 0 6px">
          <div class="grow"><strong>Combina√ß√µes cadastradas</strong></div>
          <input id="filtroTabela" placeholder="Filtrar‚Ä¶ (origem, destino, valor)" style="width:240px">
          <button class="btn" id="btnExportar">Exportar JSON</button>
        </div>
        <div style="max-height:420px;overflow:auto;margin-top:8px">
          <table class="table" id="tabela">
            <thead>
              <tr><th>Origem</th><th>Destino</th><th style="text-align:right">Valor (R$)</th><th style="text-align:right">A√ß√µes</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- AJUSTES -->
      <section id="tab-ajustes" class="card section">
        <h2 style="margin:0 0 8px">Ajustes em massa</h2>
        <div class="grid cols-2">
          <div class="card" style="box-shadow:none">
            <label>Bairro alvo</label>
            <input list="dl-bairros" id="ajBairro" placeholder="Ex.: Lagoa Nova">
            <label style="margin-top:8px">Acrescentar (R$) ‚Äî negativo para reduzir</label>
            <input id="ajValor" type="text" inputmode="decimal" value="1,00">
            <div style="margin-top:10px"><button class="btn" id="btnAplicarBairro">Aplicar nos ligados ao bairro</button></div>
          </div>
          <div class="card" style="box-shadow:none">
            <label>Acrescentar a todos (R$)</label>
            <input id="ajGlobal" type="text" inputmode="decimal" value="0,50">
            <div style="margin-top:10px"><button class="btn" id="btnAplicarGlobal">Aplicar em todas as combina√ß√µes</button></div>
          </div>
        </div>
        <div id="ajFeedback" style="color:var(--muted);margin-top:8px"></div>
      </section>

      <!-- DADOS -->
      <section id="tab-dados" class="card section">
        <h2 style="margin:0 0 8px">Dados</h2>
        <div class="grid cols-2">
          <div>
            <p>Agora os dados ficam no <strong>banco de dados</strong>. O bot√£o abaixo exporta um JSON do que est√° no servidor.</p>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn" id="btnDump">Ver JSON atual</button>
            </div>
          </div>
          <div>
            <ul style="margin:0;color:var(--muted)">
              <li>Consulte por bairros; se n√£o existir, calcule rota por ruas (OSRM).</li>
              <li>Edite/Exclua combina√ß√µes e fa√ßa ajustes em massa por bairro ou global.</li>
            </ul>
          </div>
        </div>
        <pre id="dump" class="card" style="white-space:pre-wrap"></pre>
      </section>

      <section id="tab-testes" class="card section">
        <h2 style="margin:0 0 8px">Testes</h2>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="grow"><strong>Auto-teste (contra API)</strong></div>
          <button class="btn" id="btnRunTests">Rodar Testes</button>
        </div>
        <pre id="testsOut" class="card" style="white-space:pre-wrap;min-height:120px"></pre>
      </section>

      <datalist id="dl-bairros">
        {% for b in bairros %}
          <option value="{{ b|e }}"></option>
        {% endfor %}
      </datalist>
    </main>
  </div>

  <!-- Painel Street View -->
  <div id="streetPanel" class="street-panel" aria-live="polite">
    <header class="bar">
      <strong style="flex:1">Explorar rua (Mapillary)</strong>
      <button class="btn" id="closeStreet">Fechar</button>
      <a class="btn" id="openExternal" target="_blank" rel="noopener">Abrir em nova aba</a>
    </header>
    <iframe id="streetIframe" class="street-iframe" title="Street View (Mapillary)"></iframe>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ======== Tema ======== */
(function(){
  try{
    const pref = localStorage.getItem('coopex_theme');
    const btn = document.getElementById('btnTheme');
    function apply(mode){
      document.documentElement.removeAttribute('data-theme-forced');
      document.body.classList.remove('dark');
      if(mode==='dark'){ document.body.classList.add('dark'); document.documentElement.setAttribute('data-theme-forced','dark'); btn.textContent='Tema: escuro'; }
      else if(mode==='light'){ document.documentElement.setAttribute('data-theme-forced','light'); btn.textContent='Tema: claro'; }
      else { btn.textContent='Tema: auto'; }
      localStorage.setItem('coopex_theme_subpage', mode);
    }
    if(pref==='dark') apply('dark');
    else if(pref==='light') apply('light');
    else apply(localStorage.getItem('coopex_theme_subpage')||'auto');
    btn.addEventListener('click', ()=>{
      const cur = localStorage.getItem('coopex_theme_subpage')||'auto';
      const next = cur==='auto' ? 'dark' : cur==='dark' ? 'light' : 'auto';
      apply(next);
    });
  }catch(_){}
})();

/* ======== Helpers ======== */
const $$  = sel => document.querySelector(sel);
const $$$ = sel => Array.from(document.querySelectorAll(sel));
const ROOT = document.querySelector('.layout');
const END_LIST    = ROOT.dataset.endList;
const END_UPSERT  = ROOT.dataset.endUpsert;
const END_DELETE0 = ROOT.dataset.endDelete; // prefixo sem o √∫ltimo 0
const END_AJUSTES = ROOT.dataset.endAjustes;
const END_PERKM   = ROOT.dataset.endPerkm;

function toast(msg){
  const el = $$('#toast'); el.textContent = msg; el.classList.add('show');
  setTimeout(()=> el.classList.remove('show'), 1800);
}
function alpha(a,b){ return a.localeCompare(b,'pt-BR',{sensitivity:'base'}); }
function moeda(n){ if(Number.isNaN(n)) return '‚Äî'; return Number(n).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }

/* >>>>>>> PARSER CORRIGIDO (BR + EN) <<<<<<< */
function parseValor(s){
  if(s==null) return NaN;
  if(typeof s === 'number') return s;
  let str = String(s).trim();

  const hasComma = str.includes(',');
  const hasDot   = str.includes('.');

  if (hasComma && hasDot){
    // Formato brasileiro 1.234,56 -> remove milhares e troca v√≠rgula por ponto
    str = str.replace(/\./g,'').replace(',', '.');
  }else if (hasComma && !hasDot){
    // 12,50 -> 12.50
    str = str.replace(',', '.');
  } else {
    // 12.50 -> mant√©m; 1250 -> mant√©m
    // nada
  }
  const v = Number(str);
  return Number.isFinite(v) ? v : NaN;
}

function uniq(arr){ return Array.from(new Set(arr)); }
function norm(s){ return (s||'').toString().trim().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase(); }

/* ======== Estado ======== */
let LISTA = [];      // {id, origem, destino, valor}
let Bairros = [];    // datalist vindo do servidor (n√£o usado para contagem)
let perKm  = parseFloat("{{ '%.2f' % per_km }}");

/* ======== Abas ======== */
function goTab(id){
  $$$('.nav a').forEach(x=> x.classList.remove('active'));
  const link = $$(`.nav a[href="${id}"]`); if(link) link.classList.add('active');
  $$$('.section').forEach(s=> s.classList.remove('active'));
  const el = $$(id); if(el) el.classList.add('active');
  if(id==='#tab-endereco'){ ensureMap(); setTimeout(fixMapSize, 120); }
}
$$$('.nav a[data-gotab]').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    goTab(a.getAttribute('href'));
  });
});

/* ======== Tabela ======== */
function renderTabela(){
  const tbody = $$('#tabela tbody'); if(!tbody) return;
  const q = ($$('#filtroTabela')?.value||'').trim().toLowerCase();

  let rows = LISTA;
  if(q){
    rows = rows.filter(r =>
      r.origem.toLowerCase().includes(q) ||
      r.destino.toLowerCase().includes(q) ||
      String(r.valor).includes(q)
    );
  }
  rows = rows.slice().sort((a,b)=> alpha(a.origem,b.origem) || alpha(a.destino,b.destino));

  // Estat√≠sticas com base na tabela real
  $$('#statTotal').textContent = LISTA.length;
  const uniqBairros = uniq(LISTA.flatMap(x=>[x.origem,x.destino]).map(s=>s?.trim()).filter(Boolean));
  $$('#statBairros').textContent = uniqBairros.length;

  tbody.innerHTML = rows.map(r=>`
    <tr>
      <td>${r.origem}</td>
      <td>${r.destino}</td>
      <td style="text-align:right">${moeda(r.valor)}</td>
      <td style="text-align:right">
        <button class="btn" onclick="editComb(${r.id})">Editar</button>
        <button class="btn" style="background:#fff;border-color:#ef4444;color:#ef4444" onclick="delComb(${r.id})">Excluir</button>
      </td>
    </tr>
  `).join('') || `<tr><td colspan="4" style="color:var(--muted)">Nenhum registro ainda.</td></tr>`;

  // Atualiza o datalist com o que existe nos itens
  const dl = $$('#dl-bairros');
  dl.innerHTML = uniqBairros
    .slice().sort((a,b)=>alpha(a,b))
    .map(b=>`<option value="${b.replace(/"/g,'&quot;')}"></option>`).join('');
}

function fillDatalist(){
  // fallback para quando n√£o h√° itens ainda
  const dl = $$('#dl-bairros');
  dl.innerHTML = Bairros.map(b=>`<option value="${b.replace(/"/g,"&quot;")}"></option>`).join('');
}

async function reloadLista(){
  const url = new URL(END_LIST, window.location.origin);
  const q = ($$('#filtroTabela')?.value||'').trim();
  if(q) url.searchParams.set('q', q);
  const r = await fetch(url.toString(), {credentials:'same-origin'});
  const j = await r.json();
  LISTA = j.items||[];
  Bairros = j.bairros||[];
  perKm = j.per_km ?? perKm;
  $$('#outPerKm').value = Number(perKm).toFixed(2);
  if(LISTA.length){ renderTabela(); } else { fillDatalist(); renderTabela(); }
}

/* ======== CRUD ======== */
function editComb(id){
  const it = LISTA.find(x=> x.id===id); if(!it) return;
  goTab('#tab-cadastro');
  $$('#cOrigem').value = it.origem;
  $$('#cDestino').value = it.destino;
  $$('#cValor').value = Number(it.valor).toFixed(2);
}

async function upsertComb(){
  const origem = ($$('#cOrigem').value||'').trim();
  const destino = ($$('#cDestino').value||'').trim();
  const v = parseValor($$('#cValor').value);
  if(!origem || !destino || !Number.isFinite(v)){ alert('Preencha origem, destino e valor v√°lido.'); return; }

  const r = await fetch(END_UPSERT, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'same-origin',
    body: JSON.stringify({origem, destino, valor: v})
  });
  const j = await r.json();
  if(!r.ok || j.error){ alert(j.error || 'Falha ao salvar'); return; }
  toast('Salvo!');
  await reloadLista();
  $$('#cValor').value = Number(v).toFixed(2);
}

async function delComb(id){
  if(!confirm('Excluir este registro?')) return;
  const r = await fetch(`${END_DELETE0}${id}`, {method:'DELETE', credentials:'same-origin'});
  const j = await r.json();
  if(!r.ok || j.error){ alert(j.error || 'Falha ao excluir'); return; }
  toast('Exclu√≠do!');
  await reloadLista();
}

/* ======== Consulta de pre√ßo ======== */
function consultar(){
  const o = norm($$('#qOrigem').value);
  const d = norm($$('#qDestino').value);
  if(!o || !d){ setConsulta('‚Äî','preencha origem e destino','warn'); return; }
  const it = LISTA.find(x=> norm(x.origem)===o && norm(x.destino)===d);
  if(!it){ setConsulta('Sem cadastro','use Endere√ßo/CEP (rotas)','danger'); }
  else { setConsulta(moeda(Number(it.valor)), 'pre√ßo cadastrado','ok'); }
}
function setConsulta(text,status,badge){
  $$('#consultaResultado').textContent = text;
  $$('#consultaStatus').textContent = status;
  $$('#consultaStatus').className = 'chip ' + (badge==='ok' ? 'badge-ok' : badge==='warn' ? 'badge-warn' : 'badge-danger');
}

/* ======== Ajustes em massa ======== */
async function aplicarPorBairro(){
  const bairro = ($$('#ajBairro').value||'').trim();
  const delta  = parseValor($$('#ajValor').value);
  if(!bairro || !Number.isFinite(delta)){ alert('Informe bairro e valor v√°lido.'); return; }
  const r = await fetch(END_AJUSTES, {
    method:'PATCH', headers:{'Content-Type':'application/json'}, credentials:'same-origin',
    body: JSON.stringify({bairro, delta})
  });
  const j = await r.json();
  if(!r.ok || j.error){ alert(j.error || 'Falha ao aplicar'); return; }
  toast(`Ajustadas ${j.changed} combina√ß√µes.`);
  $$('#ajFeedback').textContent = `Ajustadas ${j.changed} combina√ß√µes ligadas a "${bairro}" em R$ ${delta.toFixed(2)}.`;
  await reloadLista();
}
async function aplicarGlobal(){
  const g = parseValor($$('#ajGlobal').value);
  if(!Number.isFinite(g)){ alert('Valor inv√°lido.'); return; }
  const r = await fetch(END_AJUSTES, {
    method:'PATCH', headers:{'Content-Type':'application/json'}, credentials:'same-origin',
    body: JSON.stringify({global_delta: g})
  });
  const j = await r.json();
  if(!r.ok || j.error){ alert(j.error || 'Falha ao aplicar'); return; }
  toast(`Ajustadas ${j.changed} combina√ß√µes.`);
  $$('#ajFeedback').textContent = `Ajustadas ${j.changed} combina√ß√µes em R$ ${g.toFixed(2)} (global).`;
  await reloadLista();
}

/* ======== Rotas & pre√ßo estimado ======== */
async function viaCEP(cep){ cep=(cep||'').replace(/\D/g,''); if(cep.length!==8) return null;
  const r=await fetch(`https://viacep.com.br/ws/${cep}/json/`); if(!r.ok) return null; const j=await r.json(); if(j.erro) return null; return j;}
async function geocode(q){ const url=`https://nominatim.openstreetmap.org/search?format=json&countrycodes=br&limit=5&addressdetails=1&q=${encodeURIComponent(q)}`; const r=await fetch(url,{headers:{'Accept-Language':'pt-BR'}}); if(!r.ok) throw new Error('Falha ao geocodificar'); const j=await r.json(); return j.map(it=>({label:it.display_name, lat:+it.lat, lon:+it.lon}));}
async function osrmRouteKm(a,b){ const url = `https://router.project-osrm.org/route/v1/driving/${a.lon},${a.lat};${b.lon},${b.lat}?overview=full&geometries=geojson`; const r=await fetch(url); if(!r.ok) throw new Error('OSRM indispon√≠vel'); const j=await r.json(); if(!j.routes?.length) throw new Error('Sem rota'); const distKm=j.routes[0].distance/1000; const coords=j.routes[0].geometry.coordinates.map(([x,y])=>[y,x]); return {km:distKm,line:coords};}
function haversineKm(a,b){ const R=6371,dLat=rad(b.lat-a.lat),dLon=rad(b.lon-a.lon); const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2); const q=s1*s1 + Math.cos(rad(a.lat))*Math.cos(rad(b.lat))*s2*s2; return R*2*Math.asin(Math.min(1,Math.sqrt(q))); }
function rad(d){ return d*Math.PI/180; }

let map, markerO, markerD, routeLayer;
function ensureMap(){ if(map) return map; map = L.map('map',{zoomControl:true}).setView([-5.794,-35.211], 12); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map); setTimeout(()=> map.invalidateSize(), 60); return map; }
function fixMapSize(){ if(map){ setTimeout(()=> map.invalidateSize(), 60); } }
function setMarker(which, lat, lon){
  ensureMap();
  const color = which==='O'? getComputedStyle(document.documentElement).getPropertyValue('--origin').trim()||'#10b981' : getComputedStyle(document.documentElement).getPropertyValue('--dest').trim()||'#ef4444';
  const icon = L.divIcon({html:`<div style="width:14px;height:14px;border-radius:999px;background:${color};border:2px solid #fff;box-shadow:0 0 0 2px rgba(0,0,0,.15)"></div>`,iconSize:[14,14],className:''});
  if(which==='O'){ if(markerO) markerO.remove(); markerO = L.marker([lat,lon],{icon}).addTo(map).bindPopup('Origem').openPopup(); }
  else { if(markerD) markerD.remove(); markerD = L.marker([lat,lon],{icon}).addTo(map).bindPopup('Destino').openPopup(); }
}
function drawRoute(latlngs){
  ensureMap();
  if(routeLayer) routeLayer.remove();
  const color = getComputedStyle(document.documentElement).getPropertyValue('--map-stroke').trim()||'#1f77b4';
  routeLayer = L.polyline(latlngs,{weight:6,opacity:.98,color}).addTo(map);
  const group = new L.featureGroup([markerO, markerD, routeLayer].filter(Boolean));
  map.fitBounds(group.getBounds().pad(0.25));
  fixMapSize();
}

/* Sugest√µes & CEP */
let debTimer; function debounce(fn,ms){ return (...args)=>{ clearTimeout(debTimer); debTimer=setTimeout(()=>fn(...args),ms); }; }
async function sugestionar(inputEl, holderId){
  const q=(inputEl.value||'').trim();
  const holder=$$(holderId);
  if(!q || q.length<3){ holder.style.display='none'; holder.innerHTML=''; return; }
  holder.style.display='block'; holder.textContent='Buscando‚Ä¶';
  try{
    const items=await geocode(q);
    holder.innerHTML = items.map(it=>`<button class="btn" style="width:100%;text-align:left" onclick='selSug("${holderId}", ${JSON.stringify(it).replace(/'/g,"&apos;")})'>${it.label}</button>`).join('');
  }catch(e){ holder.textContent='Sem sugest√µes.'; }
}
function selSug(holderId, obj){
  const holder=$$(holderId); holder.style.display='none'; holder.innerHTML='';
  const input = holderId.includes('Origem')? $$('#endOrigem') : $$('#endDestino');
  input.value=obj.label; input.dataset.lat=obj.lat; input.dataset.lon=obj.lon;
  setMarker(holderId.includes('Origem')?'O':'D', obj.lat, obj.lon);
}
async function preencherPorCEP(cepEl, endEl, sugId){
  const j=await viaCEP(cepEl.value); if(!j) return;
  const texto = `${j.logradouro||''}, ${j.bairro||''}, ${j.localidade||''} - ${j.uf}`.replace(/^[,\s]+|[,\s]+$/g,'');
  endEl.value=texto; debounce(()=>sugestionar(endEl, sugId), 60)();
}

/* Rota + pre√ßo */
async function calcularRota(){
  const o={lat:Number($$('#endOrigem').dataset.lat), lon:Number($$('#endOrigem').dataset.lon)};
  const d={lat:Number($$('#endDestino').dataset.lat), lon:Number($$('#endDestino').dataset.lon)};
  if([o.lat,o.lon,d.lat,d.lon].some(x=>Number.isNaN(x))){ alert('Selecione uma sugest√£o para origem e destino.'); return; }
  ensureMap(); fixMapSize();
  try{
    const {km,line}=await osrmRouteKm(o,d);
    $$('#outKm').value=km.toFixed(2);
    const pk=parseValor($$('#outPerKm').value || perKm || 0);
    const preco = Math.round(km*pk*100)/100;
    $$('#outPreco').value = moeda(preco);
    drawRoute(line);
  }catch(e){
    const km=haversineKm(o,d);
    $$('#outKm').value=km.toFixed(2);
    const pk=parseValor($$('#outPerKm').value || perKm || 0);
    const preco = Math.round(km*pk*100)/100;
    $$('#outPreco').value = moeda(preco);
    drawRoute([[o.lat,o.lon],[d.lat,d.lon]]);
  }
}
function inverterEnd(){
  const eo=$$('#endOrigem'), ed=$$('#endDestino');
  const vo=eo.value, vd=ed.value, lo=eo.dataset.lat, ln=eo.dataset.lon;
  eo.value=vd; ed.value=vo; eo.dataset.lat=ed.dataset.lat; eo.dataset.lon=ed.dataset.lon; ed.dataset.lat=lo; ed.dataset.lon=ln;
  if(eo.dataset.lat && eo.dataset.lon) setMarker('O', Number(eo.dataset.lat), Number(eo.dataset.lon));
  if(ed.dataset.lat && ed.dataset.lon) setMarker('D', Number(ed.dataset.lat), Number(ed.dataset.lon));
}

/* ======== Street View gratuito (Mapillary em iframe) ======== */
let streetEnabled = false;
const panel = $$('#streetPanel');
const iframe = $$('#streetIframe');
const openExternal = $$('#openExternal');
const btnStreet = $$('#btnStreet');

function openStreetAt(lat, lon){
  const url = `https://www.mapillary.com/app/?lat=${lat}&lng=${lon}&z=17&focus=photo`;
  iframe.src = url;
  openExternal.href = url;
  panel.style.display = 'block';
}
btnStreet.addEventListener('click', ()=>{
  streetEnabled = !streetEnabled;
  btnStreet.textContent = streetEnabled ? 'Street: clique no mapa (Ativo)' : 'Explorar rua (clique no mapa)';
  toast(streetEnabled ? 'Clique no mapa para abrir o Street View (Mapillary).' : 'Street desativado.');
});
$$('#closeStreet').addEventListener('click', ()=>{ panel.style.display = 'none'; iframe.src = 'about:blank'; });
function onMapClick(e){ if(!streetEnabled) return; openStreetAt(e.latlng.lat, e.latlng.lng); }
(function attachMapClickLater(){
  const iv = setInterval(()=>{ if(map){ map.on('click', onMapClick); clearInterval(iv);} }, 200);
})();

/* ======== Eventos ======== */
$$('#btnConsultar').addEventListener('click', consultar);
$$('#btnExportar').addEventListener('click', exportarJSON);
$$('#btnDump').addEventListener('click', dumpJSON);
$$('#btnAplicarBairro').addEventListener('click', aplicarPorBairro);
$$('#btnAplicarGlobal').addEventListener('click', aplicarGlobal);
$$('#savePerKm').addEventListener('click', salvarPerKm);
$$('#btnSalvar').addEventListener('click', upsertComb);
$$('#btnLimpar').addEventListener('click',()=> { $$('#cOrigem').value=''; $$('#cDestino').value=''; $$('#cValor').value=''; });
$$('#filtroTabela').addEventListener('input', renderTabela);
$$('#cValor').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ upsertComb(); }});

$$('#cepOrigem').addEventListener('blur',()=> preencherPorCEP($$('#cepOrigem'), $$('#endOrigem'), '#sugOrigem'));
$$('#cepDestino').addEventListener('blur',()=> preencherPorCEP($$('#cepDestino'), $$('#endDestino'), '#sugDestino'));
$$('#endOrigem').addEventListener('input', debounce(()=> sugestionar($$('#endOrigem'), '#sugOrigem'), 300));
$$('#endDestino').addEventListener('input', debounce(()=> sugestionar($$('#endDestino'), '#sugDestino'), 300));
$$('#btnCalcularKm').addEventListener('click', calcularRota);
$$('#btnInverter').addEventListener('click', inverterEnd);

/* ======== Per Km ======== */
async function salvarPerKm(){
  const v = parseValor($$('#perKm').value);
  if(!Number.isFinite(v)){ alert('R$ por km inv√°lido'); return; }
  const r = await fetch(END_PERKM, {
    method:'POST', headers:{'Content-Type':'application/json'}, credentials:'same-origin',
    body: JSON.stringify({per_km: v})
  });
  const j = await r.json();
  if(!r.ok || j.error){ alert(j.error || 'Falha ao salvar'); return; }
  toast('R$/km salvo!');
  perKm = j.per_km;
  $$('#outPerKm').value = Number(perKm).toFixed(2);
}

/* ======== Export JSON / Dump ======== */
function exportarJSON(){
  const blob = new Blob([JSON.stringify({items: LISTA, perKm}, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'tabela-precos.json';
  a.click(); URL.revokeObjectURL(a.href);
}
async function dumpJSON(){
  const r = await fetch(END_LIST, {credentials:'same-origin'});
  const j = await r.json();
  const blob = JSON.stringify(j, null, 2);
  $$('#dump').textContent = blob;
}

/* ======== Teste r√°pido contra API ======== */
async function runTests(){
  const out = $$('#testsOut'); const logs=[];
  try{
    logs.push('üîÑ Recarregando lista...');
    await reloadLista();
    logs.push('‚úÖ GET /api/precos OK ('+LISTA.length+' itens)');
    const tOrigem='Teste Bairro A', tDestino='Teste Bairro B', tValor=12.34;
    const r = await fetch(END_UPSERT, {method:'POST', headers:{'Content-Type':'application/json'}, credentials:'same-origin', body: JSON.stringify({origem:tOrigem,destino:tDestino,valor:tValor})});
    const j = await r.json(); if(!r.ok||j.error) throw new Error(j.error||'POST falhou');
    logs.push('‚úÖ POST /api/precos OK');
    await reloadLista();
    if(!LISTA.find(x=> x.origem===tOrigem && x.destino===tDestino)) throw new Error('Registro n√£o apareceu');
    logs.push('‚úÖ Registro apareceu na listagem');
    out.textContent = logs.join('\n');
  }catch(e){
    logs.push('‚ùå Falha: '+e.message);
    out.textContent = logs.join('\n');
  }
}
$$('#btnRunTests').addEventListener('click', runTests);

/* ======== Init ======== */
(async function init(){
  await reloadLista();
  $$('#outPerKm').value = Number(perKm||3).toFixed(2);
})();
</script>
</body>
</html>
